---
title: "CASA0005 Coursework - Code"
output: html_document
editor_options: 
  chunk_output_type: console
---
### Packages
```{r}
library(tidyverse)
library(raster)
library(rgdal)
library(sf)
library(tmap)
library(leafpop)
library(leaflet)
library(htmltools)
library(GISTools)
library(RColorBrewer)
library(BAMMtools)
library(spdep)
library(broom)
library(corrplot)
library(car)
library(spgwr)

# Set tmap to view mode
tmap_mode("view")
```

### Read in Concentration Rasters
```{r}
# List the full file paths of all the raster files.
PollutionFiles <- list.files("Data/Air Pollution/LAEI 2016 Concentrations", ".tif", full.names = TRUE)

# Stack the raster files into a single stack.
PollutionConc <- stack(PollutionFiles)

# List the raster names.
PollutionNames <- c("NO2", "PM2.5")

# Rename the raster files.
names(PollutionConc) <- PollutionNames

# Set BNG coordinate system.
BNG = "+init=epsg:27700"

# Set WGS84 coordinate system.
WGS84 = "+init=epsg:4326"

# Reproject raster stack into BNG.
PollutionConc <- projectRaster(PollutionConc, crs= WGS84)

```

### Crop Raster Data
```{r}
# Read in the London boundary.
OutlineLondon <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/London_Boundary.shp")

# Transform CRS into WGS84.
OutlineLondon <- st_transform(OutlineLondon, WGS84)

# Set extent to the London area.
ExtentLondon <- extent(OutlineLondon)

# Crop the rasters to the London outline.
CropNO2 <- crop(PollutionConc[[1]], OutlineLondon)
CropPM2.5 <- crop(PollutionConc[[2]], OutlineLondon)

# Mask rasters to the London outline.
MaskNO2 <-  mask(PollutionConc[[1]], OutlineLondon, na.rm=TRUE)
MaskPM2.5 <-  mask(PollutionConc[[2]], OutlineLondon, na.rm=TRUE)

# Stack the masked rasters.
PollutionLondon <- stack(MaskNO2, MaskPM2.5)
```

### Read in Boundaries
```{r}
# Read in boundaries as spatial polygons.
LAD <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/London_Borough_Excluding_MHW.shp")
MSOA <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/MSOA_2011_London_gen_MHW.shp")
LSOA <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/LSOA_2011_London_gen_MHW.shp")

# Convert from an sp object to sf object.
SFLAD <- st_as_sf(LAD)
SFMSOA <- st_as_sf(MSOA)
SFLSOA <- st_as_sf(LSOA)

# Transform CRS to WGS84.
SFLAD <- st_transform(SFLAD, WGS84)
SFMSOA <- st_transform(SFMSOA, WGS84)
SFLSOA <- st_transform(SFLSOA, WGS84)

# Select relevent columns.
SFLAD <- SFLAD[,c(1, 2, 8)]
SFMSOA <- SFMSOA[,c(2, 1, 4, 3, 13)]
SFLSOA <- SFLSOA[,c(2, 1, 4, 3, 6, 5, 15)]

# Rename columns.
colnames(SFLAD) <- c("LAD Name", "LAD Code", "geometry")
colnames(SFMSOA) <- c("MSOA Name", "MSOA Code", "LAD Name", "LAD Code", "geometry")
colnames(SFLSOA) <- c("LSOA Name", "LSOA Code", "MSOA Name", "MSOA Code","LAD Name", "LAD Code", "geometry")

```

### Read in School, GP and Hospital Data
```{r}
# Read in code points.
AllCodePoints <- read_csv("Data/Schools and Health/OS Point Codes/Data/AllCodePoints.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")

# Read in  data.
Schools <- read_csv("Data/Schools and Health/All School Locations 2016.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
GPs <- read_csv("Data/Schools and Health/GP Locations.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
Hospitals <- read_csv("Data/Schools and Health/Hospital Locations.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
# Select the necessary columns.
Schools <- Schools[,c(3, 8)]
GPs <- GPs[,c(1, 9)]
Hospitals <- Hospitals[,c(1, 9)]

# Rename Columns.
colnames(Schools) <- c("Name", "Postcode")
colnames(GPs) <- c("Name", "Postcode")
colnames(Hospitals) <- c("Name", "Postcode")

# Classify data.
Schools$Type <- "School"
GPs$Type <- "GP"
Hospitals$Type <- "Hospital"

# Merge school, GP and hospital points.
Locations <- rbind(Schools, GPs, Hospitals)

# Remove space in postcodes
Locations$Postcode <- gsub(" ","", Locations$Postcode)

# Attach code points.
Locations<-merge(Locations, 
             AllCodePoints, 
             by.x="Postcode", 
             by.y="Postcode",
             no.dups = TRUE)

# Reorder columns
Locations <- Locations[,c(2, 1, 3, 4, 5)]

# Remove duplicates.
Locations <- Locations[!duplicated(Locations$Name), ]

```

### Extract Concentrations for Schools, GPs and Hospitals
```{r}
# Convert location coordinates into point geometry.
SFLocations <- st_as_sf(Locations, coords = c("Eastings", "Northings"), crs = BNG)

# Transform CRS into WGS84.
SFLocations <- st_transform(SFLocations, WGS84)

# Select points inside London.
SFLocations <- SFLocations[SFLAD,]

# Extract concentrations.
SFLocations$`NO2 (µg/m³)`<- raster::extract(PollutionConc[[1]], SFLocations)
SFLocations$`PM2.5 (µg/m³)`<- raster::extract(PollutionConc[[2]], SFLocations)

# Round concentrations to 2 d.p..
SFLocations$`NO2 (µg/m³)` <- round(SFLocations$`NO2 (µg/m³)`, digits = 2)
SFLocations$`PM2.5 (µg/m³)` <- round(SFLocations$`PM2.5 (µg/m³)`, digits = 2)

# Rename columns.
colnames(SFLocations) <- c("Building Name", "Postcode", "Building Type", "geometry", "NO2 (µg/m³)", "PM2.5 (µg/m³)")

# Extract schools, GPs and hospitals that exceed WHO guides
SFLocationsNO2 <- SFLocations %>% filter(`NO2 (µg/m³)` > 40)
SFLocationsPM2.5 <- SFLocations %>% filter(`PM2.5 (µg/m³)` > 10)

```

### Subset Location Data
```{r}
SFSchools <- subset(SFLocations, `Building Type` == "School")

SFGPs <- subset(SFLocations, `Building Type` == "GP")

SFHospitals <- subset(SFLocations, `Building Type` == "Hospital")

SFSchoolsNO2 <- subset(SFLocationsNO2, `Building Type` == "School")

SFGPsNO2 <- subset(SFLocationsNO2, `Building Type` == "GP")

SFHospitalsNO2 <- subset(SFLocationsNO2, `Building Type` == "Hospital")

SFSchoolsPM2.5 <- subset(SFLocationsPM2.5, `Building Type` == "School")

SFGPsPM2.5 <- subset(SFLocationsPM2.5, `Building Type` == "GP")

SFHospitalsPM2.5 <- subset(SFLocationsPM2.5, `Building Type` == "Hospital")

```

### MSOA Cluster Data for Points
```{r}
# Convert SF objects into SP objects
SPPointCluster <- as(SFMSOA, "Spatial")
SPSchools <- as(SFSchools, "Spatial")
SPGPs <- as(SFGPs, "Spatial")
SPHospitals <- as(SFHospitals, "Spatial")
SPSchoolsNO2 <- as(SFSchoolsNO2, "Spatial")
SPGPsNO2 <- as(SFGPsNO2, "Spatial")
SPHospitalsNO2 <- as(SFHospitalsNO2, "Spatial")
SPSchoolsPM2.5 <- as(SFSchoolsPM2.5, "Spatial")
SPGPsPM2.5 <- as(SFGPsPM2.5, "Spatial")
SPHospitalsPM2.5 <- as(SFHospitalsPM2.5, "Spatial")

# Transform CRS to BNG (a projected CRS).
SPPointCluster <- spTransform(SPPointCluster, BNG)
SPSchools <- spTransform(SPSchools, BNG)
SPGPs <- spTransform(SPGPs, BNG)
SPHospitals <- spTransform(SPHospitals, BNG)
SPSchoolsNO2 <- spTransform(SPSchoolsNO2, BNG)
SPGPsNO2 <- spTransform(SPGPsNO2, BNG)
SPHospitalsNO2 <- spTransform(SPHospitalsNO2, BNG)
SPSchoolsPM2.5 <- spTransform(SPSchoolsPM2.5, BNG)
SPGPsPM2.5 <- spTransform(SPGPsPM2.5, BNG)
SPHospitalsPM2.5 <- spTransform(SPHospitalsPM2.5, BNG)

# Count the number of points in each MSOA.
SPPointCluster@data$SchoolCount <- poly.counts(SPSchools, SPPointCluster)
SPPointCluster@data$GPCount <- poly.counts(SPGPs, SPPointCluster)
SPPointCluster@data$HospitalCount <- poly.counts(SPHospitals, SPPointCluster)
SPPointCluster@data$SchoolNO2Count <- poly.counts(SPSchoolsNO2, SPPointCluster)
SPPointCluster@data$GPNO2Count <- poly.counts(SPGPsNO2, SPPointCluster)
SPPointCluster@data$HospitalNO2Count <- poly.counts(SPHospitalsNO2, SPPointCluster)
SPPointCluster@data$SchoolPM2.5Count <- poly.counts(SPSchoolsPM2.5, SPPointCluster)
SPPointCluster@data$GPPM2.5Count <- poly.counts(SPGPsPM2.5, SPPointCluster)
SPPointCluster@data$HospitalPM2.5Count <- poly.counts(SPHospitalsPM2.5, SPPointCluster)

# Calculate point density.
SPPointCluster@data$SchoolDensity <- round(SPPointCluster@data$SchoolCount/(poly.areas(SPPointCluster)/1000000), digits = 3)
SPPointCluster@data$GPDensity <- round(SPPointCluster@data$GPCount/(poly.areas(SPPointCluster)/1000000), digits = 3)
SPPointCluster@data$HospitalDensity <- round(SPPointCluster@data$HospitalCount/(poly.areas(SPPointCluster)/1000000), digits = 3)
SPPointCluster@data$SchoolNO2Density <- round(SPPointCluster@data$SchoolNO2Count/(poly.areas(SPPointCluster)/1000000), digits = 3)
SPPointCluster@data$GPNO2Density <- round(SPPointCluster@data$GPNO2Count/(poly.areas(SPPointCluster)/1000000), digits = 3)
SPPointCluster@data$HospitalNO2Density <- round(SPPointCluster@data$HospitalNO2Count/ (poly.areas(SPPointCluster)/1000000), digits = 3)
SPPointCluster@data$SchoolPM2.5Density <- round(SPPointCluster@data$SchoolPM2.5Count/ (poly.areas(SPPointCluster)/1000000), digits = 3)
SPPointCluster@data$GPPM2.5Density <- round(SPPointCluster@data$GPPM2.5Count/ (poly.areas(SPPointCluster)/1000000), digits = 3)
SPPointCluster@data$HospitalPM2.5Density <- round(SPPointCluster@data$HospitalPM2.5Count / (poly.areas(SPPointCluster)/1000000), digits = 3)

# Determine centroids for MSOAs
CentroidMSOA <- coordinates(SPPointCluster)
plot(CentroidMSOA)

# Create neighbour list using queen's case neighbours.
NNListMSOA <- poly2nb(SFMSOA, queen=T)
plot(NNListMSOA, coordinates(CentroidMSOA), col="red")

# Create spatial weights object.
SpWeightsMSOA <- nb2listw(NNListMSOA, style="C")

# Conduct global Moran's I.
GlbMIAllSchool <- moran.test(SPPointCluster@data$SchoolDensity, SpWeightsMSOA)
GlbMIAllGP <- moran.test(SPPointCluster@data$GPDensity, SpWeightsMSOA)
GlbMIAllHospital <- moran.test(SPPointCluster@data$HospitalDensity, SpWeightsMSOA)
GlbMINO2School <- moran.test(SPPointCluster@data$SchoolNO2Density, SpWeightsMSOA)
GlbMINO2GP <- moran.test(SPPointCluster@data$GPNO2Density, SpWeightsMSOA)
GlbMINO2Hospital <- moran.test(SPPointCluster@data$HospitalNO2Density, SpWeightsMSOA)
GlbMIPM2.5School <- moran.test(SPPointCluster@data$SchoolPM2.5Density, SpWeightsMSOA)
GlbMIPM2.5GP <- moran.test(SPPointCluster@data$GPPM2.5Density, SpWeightsMSOA)
GlbMIPM2.5Hospital <- moran.test(SPPointCluster@data$HospitalPM2.5Density, SpWeightsMSOA)

# Conduct local Moran's I.
lclMIAllSchool <- round(localmoran(SPPointCluster@data$SchoolDensity, SpWeightsMSOA), digits = 3)
lclMIAllGP <- round(localmoran(SPPointCluster@data$GPDensity, SpWeightsMSOA), digits = 3)
lclMIAllHospital <- round(localmoran(SPPointCluster@data$HospitalDensity, SpWeightsMSOA), digits = 3)
lclMINO2School <- round(localmoran(SPPointCluster@data$SchoolNO2Density, SpWeightsMSOA), digits = 3)
lclMINO2GP <- round(localmoran(SPPointCluster@data$GPNO2Density, SpWeightsMSOA), digits = 3)
lclMINO2Hospital <- round(localmoran(SPPointCluster@data$HospitalNO2Density, SpWeightsMSOA), digits = 3)
lclMIPM2.5School <- round(localmoran(SPPointCluster@data$SchoolPM2.5Density, SpWeightsMSOA), digits = 3)
lclMIPM2.5GP <- round(localmoran(SPPointCluster@data$GPPM2.5Density, SpWeightsMSOA), digits = 3)
lclMIPM2.5Hospital <- round(localmoran(SPPointCluster@data$HospitalPM2.5Density, SpWeightsMSOA), digits = 3)

# Join local Moran's I Z values to shape file.
SPPointCluster$lclMIAllSchool <- lclMIAllSchool[,4]
SPPointCluster$lclMIAllGP <- lclMIAllGP[,4]
SPPointCluster$lclMIAllHospital <- lclMIAllHospital[,4]
SPPointCluster$lclMINO2School <- lclMINO2School[,4]
SPPointCluster$lclMINO2GP <- lclMINO2GP[,4]
SPPointCluster$lclMINO2Hospital <- lclMINO2Hospital[,4]
SPPointCluster$lclMIPM2.5School <- lclMIPM2.5School[,4]
SPPointCluster$lclMIPM2.5GP <- lclMIPM2.5GP[,4]
SPPointCluster$lclMIPM2.5Hospital <- lclMIPM2.5Hospital[,4]

# Convert SP MSOA data into a data frame.
SFPointCluster <- st_as_sf(SPPointCluster)

# Transform CRS to WGS
SFPointCluster <- st_transform(SFPointCluster, WGS84)

# Rename columns.
colnames(SFPointCluster) <- c("MSOA Name", "MSOA Code", "LAD Name", "LAD Code", "School (All) Count", "GP (All) Count", "Hospital (All) Count", "School (NO2) Count", "GP (NO2) Count", "Hospital (NO2) Count", "School (PM2.5) Count", "GP (PM2.5) Count", "Hospital (PM2.5) Count", "School (All) Density", "GP (All) Density", "Hospital (All) Density", "School (NO2) Density", "GP (NO2) Density", "Hospital (NO2) Density", "School (PM2.5) Density", "GP (PM2.5) Density", "Hospital (PM2.5) Density", "School (All) Moran's I", "GP (All) Moran's I", "Hospital (All) Moran's I", "School (NO2) Moran's I", "GP (NO2) Moran's I", "Hospital (NO2) Moran's I", "School (PM2.5) Moran's I", "GP (PM2.5) Moran's I", "Hospital (PM2.5) Moran's I", "geometry")

# Moran's I breaks.
BrksMi <-c(-1000,-2.58,-1.96,-1.65,1.65,1.96,2.58,1000)

# Moran's I palette.
PalMi<- rev(brewer.pal(7, "RdBu"))

# Map Moran's I.
#tm_shape(SFPointCluster) +
#  tm_polygons(col = "School (All) Moran's I", palette = PalMi, breaks = BrksMi)
#tm_shape(SFPointCluster) +
#  tm_polygons(col = "GP (All) Moran's I", palette = PalMi, breaks = BrksMi)
#tm_shape(SFPointCluster) +
#  tm_polygons(col = "Hospital (All) Moran's I", palette = PalMi, breaks = BrksMi)
#tm_shape(SFPointCluster) +
#  tm_polygons(col = "School (NO2) Moran's I", palette = PalMi, breaks = BrksMi)
#tm_shape(SFPointCluster) +
#  tm_polygons(col = "GP (NO2) Moran's I", palette = PalMi, breaks = BrksMi)
#tm_shape(SFPointCluster) +
#  tm_polygons(col = "Hospital (NO2) Moran's I", palette = PalMi, breaks = BrksMi)
#tm_shape(SFPointCluster) +
#  tm_polygons(col = "School (PM2.5) Moran's I", palette = PalMi, breaks = BrksMi)
#tm_shape(SFPointCluster) +
#  tm_polygons(col = "GP (PM2.5) Moran's I", palette = PalMi, breaks = BrksMi)
#tm_shape(SFPointCluster) +
#  tm_polygons(col = "Hospital (PM2.5) Moran's I", palette = PalMi, breaks = BrksMi)
```

### NO2 and PM2.5. Mean Concentration
```{r}
# Read in Concentration data.
ConcLAD <- read_csv("Data/Air Pollution/ConcLAD.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
ConcMSOA <- read_csv("Data/Air Pollution/ConcMSOA.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
ConcLSOA <- read_csv("Data/Air Pollution/ConcLSOA.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")

# Extract relevent columns.
ConcLAD <- ConcLAD[,c(2:4)]
ConcMSOA <- ConcMSOA[,c(2, 5, 6)]
ConcLSOA <- ConcLSOA[,c(2, 7, 8)]

# Round concentration
ConcLAD[, c(2, 3)] <- round(ConcLAD[, c(2, 3)], digits = 3)
ConcMSOA[, c(2, 3)] <- round(ConcMSOA[, c(2, 3)], digits = 3)
ConcLSOA[, c(2, 3)] <- round(ConcLSOA[, c(2, 3)], digits = 3)

# Merge ID data to boundaries.
SFLAD<-merge(SFLAD, 
             ConcLAD, 
             by.x="LAD Code", 
             by.y="LAD Code",
             no.dups = TRUE,
             all.x = TRUE)
SFMSOA<-merge(SFMSOA, 
             ConcMSOA, 
             by.x="MSOA Code", 
             by.y="MSOA Code",
             no.dups = TRUE,
             all.x = TRUE)
SFLSOA<-merge(SFLSOA, 
             ConcLSOA, 
             by.x="LSOA Code", 
             by.y="LSOA Code",
             no.dups = TRUE,
             all.x = TRUE)
```

### MSOA Cluster Data for Areas
```{r}
# Convert SF objects into SP objects
SPAreaCluster <- as(SFMSOA, "Spatial")

# Conduct global Moran's I.
GlbMINO2 <- moran.test(SPAreaCluster@data$Mean.NO2.Conc., SpWeightsMSOA)
GlbMIPM2.5 <- moran.test(SPAreaCluster@data$Mean.PM2.5.Conc., SpWeightsMSOA)

# Conduct local Moran's I.
lclMINO2 <- round(localmoran(SPAreaCluster@data$Mean.NO2.Conc. , SpWeightsMSOA), digits = 3)
lclMIPM2.5 <- round(localmoran(SPAreaCluster@data$Mean.PM2.5.Conc. , SpWeightsMSOA), digits = 3)

# Join local Moran's I Z values to shape file.
SPAreaCluster$lclMINO2 <- lclMINO2[,4]
SPAreaCluster$lclMIPM2.5 <- lclMIPM2.5[,4]

# Convert SP MSOA data into a data frame.
SFAreaCluster <- st_as_sf(SPAreaCluster)

# Rename columns.
colnames(SFAreaCluster) <- c("MSOA Name", "MSOA Code", "LAD Name", "LAD Code", "Mean NO2 Conc.", "Mean PM2.5 Conc.", "NO2 Moran's I", "PM2.5 Moran's I", "geometry")

# Map Moran's I.
tm_shape(SFAreaCluster) +
  tm_polygons(col = "NO2 Moran's I", palette = PalMi, breaks = BrksMi)
tm_shape(SFAreaCluster) +
  tm_polygons(col = "PM2.5 Moran's I", palette = PalMi, breaks = BrksMi)
```


### Index of Multiple Deprivation 
```{r}
# Read in indices of deprivation data.
IDData <- read_csv("Data/Boundaries and Census/ID 2019 for London.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
# Merge ID data to location data.
IDData<-merge(IDData, 
             SFLSOA, 
             by.x="LSOA code (2011)", 
             by.y="LSOA Code",
             no.dups = TRUE,
             all.x = TRUE)

# Extract relevent columns.
IDData <- IDData[,c(1, 31, 33, 5)]

# Rename columns.
colnames(IDData) <- c("LSOA Code", "MSOA Code", "LAD Code", "IMD Score")

# Aggregate IDM scores to MSOA and LADs.
IDLSOA <- IDData[,c(1, 4)]
IDMSOA <- aggregate(IDData[, 4], by = list(IDData$`MSOA Code`), FUN = mean)
IDLAD <- aggregate(IDData[, 4], by = list(IDData$`LAD Code`), FUN = mean)
IDMSOA[, 2] <- round(IDMSOA[, 2], digits = 3)
IDLAD[, 2] <- round(IDLAD[, 2], digits = 3)
colnames(IDMSOA) <- c("MSOA Code", "IMD Score")
colnames(IDLAD) <- c("LAD Code", "IMD Score")

# Merge ID data to boundaries.
SFLAD<-merge(SFLAD, 
             IDLAD, 
             by.x="LAD Code", 
             by.y="LAD Code",
             no.dups = TRUE,
             all.x = TRUE)
SFMSOA<-merge(SFMSOA, 
             IDMSOA, 
             by.x="MSOA Code", 
             by.y="MSOA Code",
             no.dups = TRUE,
             all.x = TRUE)
SFLSOA<-merge(SFLSOA, 
             IDLSOA, 
             by.x="LSOA Code", 
             by.y="LSOA Code",
             no.dups = TRUE,
             all.x = TRUE)
```

### Road Density
```{r}
# Load road shapefile.
Roads <- st_read("Data/Air Pollution/LAEI 2016 Supporting Information/LAEI_MajorRoadNetwork_Link.shp")

# Tranform into an SF object.
SFRoads <- st_as_sf(Roads)

# Transform into BNG.
SFRoads <- st_transform(SFRoads, BNG)

# Select relevent columns.
SFRoads <- SFRoads[,c(6, 9, 25)]

# Rename columns.
colnames(SFRoads) <- c("Road Type", "Road Nature", "geometry")

# Copy and tranform MSOA SF into BNG
RoadsMSOA <- st_transform(SFMSOA, BNG)

# Run intersection.
RoadsMSOA <- st_intersection(SFRoads, RoadsMSOA)

# Determine road lengths.
RoadsMSOA$`Road Length (km)` <- st_length(RoadsMSOA)/1000

# Aggregate road lengths.
RoadsMSOA <- aggregate(RoadsMSOA$`Road Length (km)`, by = list(RoadsMSOA$MSOA.Code), FUN = sum)

# Rename columns.
colnames(RoadsMSOA) <- c("MSOA Code", "Road Length (km)")

# Determine road density.
RoadsMSOA$`Road Density (km/km2)` <- round(as.numeric(RoadsMSOA$`Road Length (km)` / (st_area(SFMSOA) /1000000)), digits = 2)

# Round lengths.
RoadsMSOA[, 2] <- round(as.numeric(RoadsMSOA[, 2]), digits = 2)

# Merge road length with MSOA.
SFMSOA<-merge(SFMSOA, 
             RoadsMSOA, 
             by.x="MSOA Code", 
             by.y="MSOA Code",
             no.dups = TRUE,
             all.x = TRUE)
```

### Distance from Central London (Charing Cross)
```{r}
# Create Postcode vector with Charing Cross postcode.
Postcode <- "WC2N5DU"

# Convert object to dataframe.
CharingCross <- data.frame(Postcode)

# Join code points.
CharingCross<-merge(CharingCross, 
             AllCodePoints, 
             by.x="Postcode", 
             by.y="Postcode",
             no.dups = TRUE)

# Convert Charing Cross to SF.
CharingCross <- st_as_sf(CharingCross, coords = c("Eastings", "Northings"), crs = BNG)

# Get SF MSOA Codes.
SFCentroidMSOA <- data.frame(SFMSOA$`MSOA Code`)

# Set MSOA centroids.
SFCentroidMSOA[,2:3] <- coordinates(SPPointCluster)

# Change column names.
colnames(SFCentroidMSOA) <- c("MSOA Code", "Eastings", "Northings")

# Convert to SF.
SFCentroidMSOA <- st_as_sf(SFCentroidMSOA, coords = c("Eastings", "Northings"), crs = BNG)

# Determine distance of MSOA centroids to Charing Cross.
SFCentroidMSOA$`Dist. from C. London (km)` <- round(as.numeric(st_distance(SFCentroidMSOA$geometry, CharingCross)/1000), digits = 2)

# Remove geometry.
st_geometry(SFCentroidMSOA) <- NULL

# Join to SFMSOA.
SFMSOA<-merge(SFMSOA, 
             SFCentroidMSOA, 
             by.x="MSOA Code", 
             by.y="MSOA Code",
             no.dups = TRUE,
             all.x = TRUE)
```

### Linear Regression Model
```{r}
# Conduct linear regression.
LRNO2 <- lm(`Mean NO2 Conc.` ~ `IMD Score` + `Road Density (km/km2)` + `Dist. from C. London (km)`, data = SFMSOA)
LRPM2.5 <- lm(`Mean PM2.5 Conc.` ~ `IMD Score` + `Road Density (km/km2)` + `Dist. from C. London (km)`, data = SFMSOA)

# Summarise data.
summary(LRNO2)
summary(LRPM2.5)

# Extract linear regression results.
LRResultsNO2 <- tidy(LRNO2)
LRResultsPM2.5 <- tidy(LRPM2.5)

```

### Linear Regression - Assumption 1
```{r}
# Plot histogram on variables.
ggplot(SFMSOA, aes(x=`Mean NO2 Conc.`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 1) + 
  geom_density(colour="red", size=1, adjust=1)
ggplot(SFMSOA, aes(x=`Mean PM2.5 Conc.`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 0.1) + 
  geom_density(colour="red", size=1, adjust=1)
ggplot(SFMSOA, aes(x=`IMD Score`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 1) + 
  geom_density(colour="red", size=1, adjust=1)
ggplot(SFMSOA, aes(x=`Road Density (km/km2)`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 1) + 
  geom_density(colour="red", size=1, adjust=1)
ggplot(SFMSOA, aes(x=`Dist. from C. London (km)`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 1) + 
  geom_density(colour="red", size=1, adjust=1)

# Plot Scatter plot
qplot(x = `Mean NO2 Conc.`, y = `IMD Score`, data = SFMSOA)
qplot(x = `Mean NO2 Conc.`, y = `Road Density (km/km2)`, data = SFMSOA)
qplot(x = `Mean NO2 Conc.`, y = `Dist. from C. London (km)`, data = SFMSOA)
```

### Linear Regression - Assumption 2
```{r}
# Plot linear regression model residuals in a histogram.
qplot(LRNO2$residuals) + geom_histogram() 
qplot(LRPM2.5$residuals) + geom_histogram() 
```

### Linear Regression - Assumption 3
```{r}
# Remove geometry of SFMSOA.
CorMSOA <- st_set_geometry(SFMSOA,NULL)

# Extract dependent varaiables
CorMSOA <- CorMSOA[,c("IMD Score", "Road Density (km/km2)", "Dist. from C. London (km)")]

# Calculate correlation matrix.
CorMSOA <- cor(CorMSOA, use="complete.obs", method="pearson")

# Plot correlation matrix.
corrplot(CorMSOA, type = "lower")

# Calculate VIF.
vif(LRNO2)
vif(LRPM2.5)
```

### Linear Regression - Assumption 4
```{r}
# Plot model diagnostics.
plot(LRNO2)
plot(LRPM2.5)

```

### Linear Regression - Assumption 5
```{r}
# Merge model residuals to shapefile.
SFMSOA$`LRNO2 Residuals` <- LRNO2$residuals
SFMSOA$`LRPM2.5 Residuals` <- LRPM2.5$residuals

# Map model residuals.
tm_shape(SFMSOA) +
  tm_polygons("LRNO2 Residuals", palette = "RdYlBu")
tm_shape(SFMSOA) +
  tm_polygons("LRPM2.5 Residuals", palette = "RdYlBu")

# Convert SF objects to SP objects.
SPMSOA <- as(SFMSOA, "Spatial")

# Run Moran's I on residuals.
moran.test(SPMSOA@data$LRNO2.Residuals, SpWeightsMSOA)
moran.test(SPMSOA@data$LRPM2.5.Residuals, SpWeightsMSOA)

```

### GWR
```{r}
# Calculate kernel bandwidths.
GWRbandwidthNO2 <- gwr.sel(`Mean NO2 Conc.` ~ `IMD Score` + `Road Density (km/km2)` +`Dist. from C. London (km)`, data = SFMSOA, coords=CentroidMSOA, adapt=T)
GWRbandwidthPM2.5 <- gwr.sel(`Mean PM2.5 Conc.` ~ `IMD Score` + `Road Density (km/km2)` + `Dist. from C. London (km)`, data = SFMSOA, coords=CentroidMSOA, adapt=T)

# Run the GWR model.
GWRNO2 = gwr(`Mean NO2 Conc.` ~ `IMD Score` + `Road Density (km/km2)` + `Dist. from C. London (km)`, data = SFMSOA, coords=CentroidMSOA, adapt=GWRbandwidthNO2, hatmatrix=TRUE, se.fit=TRUE)
GWRPM2.5 = gwr(`Mean PM2.5 Conc.` ~ `IMD Score` + `Road Density (km/km2)` + `Dist. from C. London (km)`, data = SFMSOA, coords=CentroidMSOA, adapt=GWRbandwidthNO2, hatmatrix=TRUE, se.fit=TRUE)

# Save the results.
GWRNO2Results <- as.data.frame(GWRNO2$SDF)
GWRPM2.5Results <- as.data.frame(GWRPM2.5$SDF)

# Merge coefficients with shapefiles.
SFMSOA$`IMD NO2 Coef.`<- round(GWRNO2Results$X.IMD.Score., digits = 3)
SFMSOA$`Road Density NO2 Coef.`<- round(GWRNO2Results$X.Road.Density..km.km2.., digits = 3)
SFMSOA$`Dist. from C. London NO2 Coef.`<- round(GWRNO2Results$X.Dist..from.C..London..km.., digits = 3)

SFMSOA$`IMD PM2.5 Coef.`<- round(GWRPM2.5Results$X.IMD.Score., digits = 3)
SFMSOA$`Road Density PM2.5 Coef.`<- round(GWRPM2.5Results$X.Road.Density..km.km2.., digits = 3)
SFMSOA$`Dist. from C. London PM2.5 Coef.`<- round(GWRPM2.5Results$X.Dist..from.C..London..km.., digits = 3)

# Map coefficients.
tm_shape(SFMSOA) +
  tm_polygons(col = "IMD NO2 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "IMD PM2.5 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "Road Density NO2 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "Road Density PM2.5 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "Dist. from C. London NO2 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "Dist. from C. London PM2.5 Coef.", palette = "RdBu", alpha = 1.0)
```
