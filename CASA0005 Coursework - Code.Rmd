---
title: "CASA0005 Coursework - Code"
output: html_document
editor_options: 
  chunk_output_type: console
---
### Packages
```{r}
library(tidyverse)
library(raster)
library(rgdal)
library(sf)
library(tmap)
library(leafpop)
library(leaflet)

```

### Read in Concentration Rasters
```{r}
# List the full file paths of all the raster files.
PollutionFiles <- list.files("Data/Air Pollution/LAEI 2016 Concentrations", ".tif", full.names = TRUE)

# Stack the raster files into a single stack.
PollutionConc <- stack(PollutionFiles)

# List the raster names.
PollutionNames <- c("NO2", "NOx", "PM10", "PM10d", "PM2.5")

# Rename the raster files.
names(PollutionConc) <- PollutionNames

# Set BNG coordinate system.
BNG = "+init=epsg:27700"

# Reproject raster stack into BNG.
PollutionConc <- projectRaster(PollutionConc, crs=BNG)

# Plot raster layers.
plot(PollutionConc[[1]])
plot(PollutionConc[[5]])

```

### Crop Raster Data
```{r}
# Read in the London boundary.
LondonOutline <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/London_Boundary.shp")
plot(LondonOutline$geometry)
LondonOutline <- st_transform(LondonOutline, 27700)

# Set extent to the London area.
LondonExtent <- extent(LondonOutline)

# Crop the rasters to the London outline.
NO2Crop <- crop(PollutionConc[[1]], LondonOutline)
NOxCrop <- crop(PollutionConc[[2]], LondonOutline)
PM10Crop <- crop(PollutionConc[[3]], LondonOutline)
PM10dCrop <- crop(PollutionConc[[4]], LondonOutline)
PM2.5Crop <- crop(PollutionConc[[5]], LondonOutline)

# Mask rasters to the London outline.
NO2Mask <-  mask(PollutionConc[[1]], LondonOutline, na.rm=TRUE)
NOxMask <-  mask(PollutionConc[[2]], LondonOutline, na.rm=TRUE)
PM10Mask <-  mask(PollutionConc[[3]], LondonOutline, na.rm=TRUE)
PM10dMask <-  mask(PollutionConc[[4]], LondonOutline, na.rm=TRUE)
PM2.5Mask <-  mask(PollutionConc[[5]], LondonOutline, na.rm=TRUE)

# Stack the masked rasters.
PollutionLon <- stack(NO2Mask, NOxMask, PM10Mask, PM10dMask, PM2.5Mask)
```

### Read in Code Points
```{r}
# List full file paths for all of the code point csv files.
CodePointsFiles <- list.files(path = "Data/Schools and Health/OS Point Codes/Data", full.names=TRUE)

# Run a function for each code point file path, reading the csvs into an object.
AllCodePoints <- lapply(CodePointsFiles,function(i){
  read.csv(i, header=FALSE, skip=4)
})

# Convert the object into a data frame.
AllCodePoints <- do.call(rbind.data.frame, AllCodePoints)

# Rename the columns.
colnames(AllCodePoints) <- c("Postcode",	"Positional_quality_indicator",	"Eastings",	"Northings",	"Country_code",	"NHS_regional_HA_code",	"NHS_HA_code",	"Admin_county_code",	"Admin_district_code",	"Admin_ward_code")

# Specify relevent columns.
AllCodePoints <- AllCodePoints[,c(1, 3, 4)]

# Remove spaces in postcodes
AllCodePoints$Postcode <- gsub(" ","", AllCodePoints$Postcode)

# Write complete dataframe into a csv file.
write.csv(AllCodePoints,"AllCodePoints.csv", row.names=FALSE)

```

### Read in School, GP and Hospital Data
```{r}
# Read in  data.
Schools <- read_csv("Data/Schools and Health/All School Locations 2016.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
GPs <- read_csv("Data/Schools and Health/GP Locations.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
Hospitals <- read_csv("Data/Schools and Health/Hospital Locations.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
# Select the necessary columns.
Schools <- Schools[,c(3, 4, 5, 8)]
GPs <- GPs[,c(1, 9)]
Hospitals <- Hospitals[,c(1, 9)]

# Rename Columns.
colnames(Schools) <- c("School Name", "Type", "Phase", "Postcode")
colnames(GPs) <- c("GP Name", "Postcode")
colnames(Hospitals) <- c("Hospital Name", "Postcode")

# Remove space in postcodes
Schools$Postcode <- gsub(" ","", Schools$Postcode)
GPs$Postcode <- gsub(" ","", GPs$Postcode)
Hospitals$Postcode <- gsub(" ","", Hospitals$Postcode)


# Attach code points.
Schools<-merge(Schools, 
             AllCodePoints, 
             by.x="Postcode", 
             by.y="Postcode",
             no.dups = TRUE)

GPs<-merge(GPs, 
             AllCodePoints, 
             by.x="Postcode", 
             by.y="Postcode",
             no.dups = TRUE)

Hospitals<-merge(Hospitals, 
             AllCodePoints, 
             by.x="Postcode", 
             by.y="Postcode",
             no.dups = TRUE)

# Remove duplicates.
Schools <- Schools[!duplicated(Schools$Postcode), ]
GPs <- GPs[!duplicated(GPs$Postcode), ]
Hospitals <- Hospitals[!duplicated(Hospitals$Postcode), ]
```

### Plot and identify Schools, GPs and Hospitals

```{r}
# Read in borough boundaries.
Boroughs <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/London_Borough_Excluding_MHW.shp")
Boroughs <- st_transform(Boroughs, 27700)

# Convert schools, GPs and hosptial coordinates into point geometry.
Schools <- st_as_sf(Schools, coords = c("Eastings", "Northings"), 
                   crs = 27700)
GPs <- st_as_sf(GPs, coords = c("Eastings", "Northings"), 
                   crs = 27700)
Hospitals <- st_as_sf(Hospitals, coords = c("Eastings", "Northings"), 
                   crs = 27700)

# Select points inside London.
Schools <- Schools[Boroughs,]
GPs <- GPs[Boroughs,]
Hospitals <- Hospitals[Boroughs,]
```

### Extract Concentrations for Schools, GPs and Hospitals
```{r}
# Extract NO2 concentrations.
Schools$NO2<- raster::extract(PollutionConc[[1]], Schools)
GPs$NO2<- raster::extract(PollutionConc[[1]], GPs)
Hospitals$NO2<- raster::extract(PollutionConc[[1]], Hospitals)

# Extract PM2.5 concentrations.
Schools$PM2.5<- raster::extract(PollutionConc[[5]], Schools)
GPs$PM2.5<- raster::extract(PollutionConc[[5]], GPs)
Hospitals$PM2.5<- raster::extract(PollutionConc[[5]], Hospitals)

# Extract schools, GPs and hospitals that exceed WHO NO2 guides
SchoolsNO2 <- Schools %>% filter(NO2 > 40)
GPsNO2 <- GPs %>% filter(NO2 > 40)
HospitalsNO2 <- Hospitals %>% filter(NO2 > 40)

# Extract schools, GPs and hospitals that exceed WHO PM2.5 guides
SchoolsPM2.5 <- Schools %>% filter(PM2.5 > 10)
GPsPM2.5 <- GPs %>% filter(PM2.5 > 10)
HospitalsPM2.5 <- Hospitals %>% filter(PM2.5 > 10)
```

### Plot Map using tmap
```{r}
# Change tmap mode.
tmap_mode("view")

# Plot map of schools, GPs and hospitals.
Map <- tm_shape(Boroughs)+ 
  tm_fill(col = NA, alpha = 0)+ 
  tm_borders(col = "black")+
tm_shape(Schools)+
  tm_dots(col = "blue", size = 0.01)+
tm_shape(GPs)+
  tm_dots(col = "green", size = 0.01)+
tm_shape(Hospitals)+
  tm_dots(col = "green", size = 0.05)
Map

# Plot map of schools, GPs and hospitals that exceed WHO NO2 guides.
MapNO2 <- tm_shape(Boroughs)+ 
  tm_fill(col = NA, alpha = 0)+ 
  tm_borders(col = "black")+
tm_shape(SchoolsNO2)+
  tm_dots(col = "orange", size = 0.01)+
tm_shape(GPsNO2)+
  tm_dots(col = "red", size = 0.01)+
tm_shape(HospitalsNO2)+
  tm_dots(col = "red", size = 0.05)
MapNO2

# Plot map of schools, GPs and hospitals that exceed WHO PM2.5 guides.
MapPM2.5 <- tm_shape(Boroughs)+ 
  tm_fill(col = NA, alpha = 0)+ 
  tm_borders(col = "black")+
tm_shape(SchoolsPM2.5)+
  tm_dots(col = "orange", size = 0.01)+
tm_shape(GPsPM2.5)+
  tm_dots(col = "red", size = 0.01)+
tm_shape(HospitalsPM2.5)+
  tm_dots(col = "red", size = 0.05)
MapPM2.5

```

