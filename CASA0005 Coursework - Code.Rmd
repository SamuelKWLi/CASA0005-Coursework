---
title: "CASA0005 Coursework - Code"
output: 
  html_document:
    theme: yeti
    smart: true
    highlight: textmate
    toc: true
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: true
editor_options: 
  chunk_output_type: console
---
# Packages
```{r}
library(tidyverse)
library(raster)
library(rgdal)
library(sf)
library(tmap)
library(leafpop)
library(leaflet)
library(htmltools)
library(GISTools)
library(RColorBrewer)
library(BAMMtools)
library(spdep)
library(broom)
library(corrplot)
library(car)
library(spgwr)

# Set tmap to view mode
tmap_mode("plot")
```

# Research Question 1

## Read in Concentration Rasters
```{r}
# List the full file paths of all the raster files.
PollutionFiles <- list.files("Data/Air Pollution/LAEI 2016 Concentrations", ".tif", full.names = TRUE)

# Stack the raster files into a single stack.
PollutionConc <- stack(PollutionFiles)

# List the raster names.
PollutionNames <- c("NO2", "PM2.5")

# Rename the raster files.
names(PollutionConc) <- PollutionNames

# Set BNG coordinate system.
BNG = "+init=epsg:27700"

# Set WGS84 coordinate system.
WGS84 = "+init=epsg:4326"

# Reproject raster stack into BNG.
PollutionConc <- projectRaster(PollutionConc, crs= WGS84)

```

## Crop Raster Data
```{r}
# Read in the London boundary.
OutlineLondon <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/London_Boundary.shp")

# Transform CRS into WGS84.
OutlineLondon <- st_transform(OutlineLondon, WGS84)

# Set extent to the London area.
ExtentLondon <- extent(OutlineLondon)

# Crop the rasters to the London outline.
CropNO2 <- crop(PollutionConc[[1]], OutlineLondon)
CropPM2.5 <- crop(PollutionConc[[2]], OutlineLondon)

# Mask rasters to the London outline.
MaskNO2 <-  mask(PollutionConc[[1]], OutlineLondon, na.rm=TRUE)
MaskPM2.5 <-  mask(PollutionConc[[2]], OutlineLondon, na.rm=TRUE)

# Stack the masked rasters.
PollutionLondon <- stack(MaskNO2, MaskPM2.5)
```

## Read in Boundaries
```{r}
# Read in boundaries as spatial polygons.
LAD <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/London_Borough_Excluding_MHW.shp")
MSOA <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/MSOA_2011_London_gen_MHW.shp")
LSOA <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/LSOA_2011_London_gen_MHW.shp")

# Convert from an sp object to sf object.
SFLAD <- st_as_sf(LAD)
SFMSOA <- st_as_sf(MSOA)
SFLSOA <- st_as_sf(LSOA)

# Transform CRS to WGS84.
SFLAD <- st_transform(SFLAD, WGS84)
SFMSOA <- st_transform(SFMSOA, WGS84)
SFLSOA <- st_transform(SFLSOA, WGS84)

# Select relevent columns.
SFLAD <- SFLAD[,c(1, 2, 8)]
SFMSOA <- SFMSOA[,c(2, 1, 4, 3, 13)]
SFLSOA <- SFLSOA[,c(2, 1, 4, 3, 6, 5, 15)]

# Rename columns.
colnames(SFLAD) <- c("LAD Name", "LAD Code", "geometry")
colnames(SFMSOA) <- c("MSOA Name", "MSOA Code", "LAD Name", "LAD Code", "geometry")
colnames(SFLSOA) <- c("LSOA Name", "LSOA Code", "MSOA Name", "MSOA Code","LAD Name", "LAD Code", "geometry")

```

## NO2 and PM2.5. Mean Concentration
```{r}
# Read in Concentration data.
ConcLAD <- read_csv("Data/Air Pollution/ConcLAD.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
ConcMSOA <- read_csv("Data/Air Pollution/ConcMSOA.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
ConcLSOA <- read_csv("Data/Air Pollution/ConcLSOA.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")

# Extract relevent columns.
ConcLAD <- ConcLAD[,c(2:4)]
ConcMSOA <- ConcMSOA[,c(2, 5, 6)]
ConcLSOA <- ConcLSOA[,c(2, 7, 8)]

# Round concentration
ConcLAD[, c(2, 3)] <- round(ConcLAD[, c(2, 3)], digits = 3)
ConcMSOA[, c(2, 3)] <- round(ConcMSOA[, c(2, 3)], digits = 3)
ConcLSOA[, c(2, 3)] <- round(ConcLSOA[, c(2, 3)], digits = 3)

# Merge ID data to boundaries.
SFLAD<-merge(SFLAD, 
             ConcLAD, 
             by.x="LAD Code", 
             by.y="LAD Code",
             no.dups = TRUE,
             all.x = TRUE)
SFMSOA<-merge(SFMSOA, 
             ConcMSOA, 
             by.x="MSOA Code", 
             by.y="MSOA Code",
             no.dups = TRUE,
             all.x = TRUE)
SFLSOA<-merge(SFLSOA, 
             ConcLSOA, 
             by.x="LSOA Code", 
             by.y="LSOA Code",
             no.dups = TRUE,
             all.x = TRUE)
```

## MSOA Cluster Data for Areas
```{r}
# Convert SF objects into SP objects
SPAreaCluster <- as(SFMSOA, "Spatial")

# Determine centroids for MSOAs
CentroidMSOA <- coordinates(SPAreaCluster)
plot(CentroidMSOA)

# Create neighbour list using queen's case neighbours.
NNListMSOA <- poly2nb(SFMSOA, queen=T)
plot(NNListMSOA, coordinates(CentroidMSOA), col="red")

# Create spatial weights object.
SpWeightsMSOA <- nb2listw(NNListMSOA, style="C")

# Conduct global Moran's I.
GlbGGNO2 <- globalG.test(SPAreaCluster@data$Mean.NO2.Conc., SpWeightsMSOA)
GlbGGPM2.5 <- globalG.test(SPAreaCluster@data$Mean.PM2.5.Conc., SpWeightsMSOA)

# Conduct local Moran's I.
lclGGNO2 <- round(localG(SPAreaCluster@data$Mean.NO2.Conc. , SpWeightsMSOA), digits = 3)
lclGGPM2.5 <- round(localG(SPAreaCluster@data$Mean.PM2.5.Conc. , SpWeightsMSOA), digits = 3)

# Join local Moran's I Z values to shape file.
SPAreaCluster$lclGGNO2 <- lclGGNO2
SPAreaCluster$lclGGPM2.5 <- lclGGPM2.5

# Convert SP MSOA data into a data frame.
SFAreaCluster <- st_as_sf(SPAreaCluster)

# Rename columns.
colnames(SFAreaCluster) <- c("MSOA Code","MSOA Name", "LAD Name","LAD Code", "Mean NO2 Conc.", "Mean PM2.5 Conc.", "NO2 Getis Ord G", "PM2.5 Getis Ord G", "geometry")

# Subset Data
SFAreaCluster_NO2 <- SFAreaCluster[, c(2, 5, 7, 9)]
SFAreaCluster_PM2.5 <- SFAreaCluster[, c(2, 6, 8, 9)]

# Rename columns.
colnames(SFAreaCluster_NO2) <- c("MSOA Name", "Mean Conc. (µg/m3)", "Getis Ord G", "geometry")
colnames(SFAreaCluster_PM2.5) <- c("MSOA Name", "Mean Conc. (µg/m3)", "Getis Ord G", "geometry")

# Moran's I breaks.
BrksMi <-c(-1000,-2.58,-1.96,-1.65,1.65,1.96,2.58,1000)

# Moran's I palette.
PalMi<- rev(brewer.pal(7, "RdBu"))

# Map Conc.
Mean_NO2_Conc <- tm_shape(SFAreaCluster_NO2) +
  tm_polygons(col = "Mean Conc. (µg/m3)", 
              palette = "seq", 
              breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80),
              midpoint = 40,
              legend.hist=TRUE)+
  tm_shape(LAD) +
  tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 2.0) +
  tm_shape(MSOA) +
    tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 1.0)+
  tm_layout(aes.palette = list(seq = "-RdYlBu"),
            main.title = "Mean NO2 Concentration for London MSOAs",
            main.title.size = 1.2,
            legend.outside = TRUE,
            legend.outside.position = "right")+
  tm_scale_bar(position = c("left", "bottom"))+
  tm_compass(north = 0,
             position = c("right", "top"))
Mean_NO2_Conc

Mean_PM2.5_Conc <- tm_shape(SFAreaCluster_PM2.5) +
  tm_polygons(col = "Mean Conc. (µg/m3)", 
              palette = "seq", 
              breaks = c(0, 2.5, 5.0, 7.5, 10, 12.5, 15.0, 17.5, 20),
              midpoint = 10,
              legend.hist=TRUE)+
  tm_shape(LAD) +
  tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 2.0) +
  tm_shape(MSOA) +
    tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 1.0)+
  tm_layout(aes.palette = list(seq = "-RdYlBu"),
            main.title = "Mean PM2.5 Concentration for London MSOAs",
            main.title.size = 1.2,
            legend.outside = TRUE,
            legend.outside.position = "right")+
  tm_scale_bar(position = c("left", "bottom"))+
  tm_compass(north = 0,
             position = c("right", "top"))
Mean_PM2.5_Conc

# Save Maps of Conc.
tmap_save(Mean_NO2_Conc, 'Results/Mean_NO2_Conc.png', units = "in", height = 5.59, width = 6.59)
tmap_save(Mean_PM2.5_Conc, 'Results/Mean_PM2.5_Conc.png', units = "in", height = 5.59, width = 6.59)

# Map Getis G.
Mean_NO2_GetisG <- tm_shape(SFAreaCluster_NO2) +
  tm_polygons(col = "Getis Ord G", 
              palette = PalMi, 
              breaks = BrksMi,
              midpoint = 0)+
  tm_shape(LAD) +
  tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 2.0) +
  tm_shape(MSOA) +
    tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 1.0)+
  tm_layout(aes.palette = list(seq = "-RdYlBu"),
            frame = FALSE)+
  tm_legend(show = FALSE)+
  tm_scale_bar(position = c("left", "bottom"))+
  tm_compass(north = 0, position = c("right", "top"))+
  tm_credits("(a)", position=c(0,0.85), size=1.5)

Mean_PM2.5_GetisG <- tm_shape(SFAreaCluster_PM2.5) +
  tm_polygons(col = "Getis Ord G", 
              palette = PalMi, 
              breaks = BrksMi,
              midpoint = 0)+
  tm_shape(LAD) +
  tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 2.0) +
  tm_shape(MSOA) +
    tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 1.0)+
  tm_layout(aes.palette = list(seq = "-RdYlBu"),
            frame = FALSE)+
  tm_legend(show = FALSE)+
  tm_scale_bar(position = c("left", "bottom"))+
  tm_compass(north = 0,
             position = c("right", "top"))+
  tm_credits("(b)", position=c(0,0.85), size=1.5)

Mean_GetisG_Legend <- tm_shape(SFAreaCluster_PM2.5) +
  tm_polygons(col = "Getis Ord G", 
              palette = PalMi, 
              breaks = BrksMi,
              midpoint = 0)+
  tm_layout(legend.only = TRUE, legend.position=c(0,0.5),asp=0.1)


Mean_GetisG <- tmap_arrange(Mean_NO2_GetisG, Mean_GetisG_Legend, Mean_PM2.5_GetisG, ncol=2, nrow = 2)
Mean_GetisG

# Save Maps of Moran's I.
tmap_save(Mean_GetisG, 'Results/Mean_GetisG.png', units = "in", height = 5.59, width = 6.59)
```

# Research Question 2

## Read in School, GP and Hospital Data
```{r}
# Read in code points.
AllCodePoints <- read_csv("Data/Schools and Health/OS Point Codes/Data/AllCodePoints.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")

# Read in  data.
Schools <- read_csv("Data/Schools and Health/All School Locations 2016.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
GPs <- read_csv("Data/Schools and Health/GP Locations.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
Hospitals <- read_csv("Data/Schools and Health/Hospital Locations.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
# Select the necessary columns.
Schools <- Schools[,c(3, 8)]
GPs <- GPs[,c(1, 9)]
Hospitals <- Hospitals[,c(1, 9)]

# Rename Columns.
colnames(Schools) <- c("Name", "Postcode")
colnames(GPs) <- c("Name", "Postcode")
colnames(Hospitals) <- c("Name", "Postcode")

# Classify data.
Schools$Type <- "School"
GPs$Type <- "GP"
Hospitals$Type <- "Hospital"

# Merge school, GP and hospital points.
Locations <- rbind(Schools, GPs, Hospitals)

# Remove space in postcodes
Locations$Postcode <- gsub(" ","", Locations$Postcode)

# Attach code points.
Locations<-merge(Locations, 
             AllCodePoints, 
             by.x="Postcode", 
             by.y="Postcode",
             no.dups = TRUE)

# Reorder columns
Locations <- Locations[,c(2, 1, 3, 4, 5)]

# Remove duplicates.
Locations <- Locations[!duplicated(Locations$Name), ]

```

## Extract Concentrations for Schools, GPs and Hospitals
```{r}
# Convert location coordinates into point geometry.
SFLocations <- st_as_sf(Locations, coords = c("Eastings", "Northings"), crs = BNG)

# Transform CRS into WGS84.
SFLocations <- st_transform(SFLocations, WGS84)

# Select points inside London.
SFLocations <- SFLocations[SFLAD,]

# Extract concentrations.
SFLocations$`NO2 (µg/m³)`<- raster::extract(PollutionConc[[1]], SFLocations)
SFLocations$`PM2.5 (µg/m³)`<- raster::extract(PollutionConc[[2]], SFLocations)

# Round concentrations to 2 d.p..
SFLocations$`NO2 (µg/m³)` <- round(SFLocations$`NO2 (µg/m³)`, digits = 2)
SFLocations$`PM2.5 (µg/m³)` <- round(SFLocations$`PM2.5 (µg/m³)`, digits = 2)

# Rename columns.
colnames(SFLocations) <- c("Building Name", "Postcode", "Building Type", "geometry", "NO2 (µg/m³)", "PM2.5 (µg/m³)")

# Extract schools, GPs and hospitals that exceed WHO guides
SFLocationsNO2 <- SFLocations %>% filter(`NO2 (µg/m³)` > 40)
SFLocationsPM2.5 <- SFLocations %>% filter(`PM2.5 (µg/m³)` > 10)

# Subset data
SFSchools <- subset(SFLocations, `Building Type` == "School")

SFGPs <- subset(SFLocations, `Building Type` == "GP")

SFHospitals <- subset(SFLocations, `Building Type` == "Hospital")

SFSchoolsNO2 <- subset(SFLocationsNO2, `Building Type` == "School")

SFGPsNO2 <- subset(SFLocationsNO2, `Building Type` == "GP")

SFHospitalsNO2 <- subset(SFLocationsNO2, `Building Type` == "Hospital")

SFSchoolsPM2.5 <- subset(SFLocationsPM2.5, `Building Type` == "School")

SFGPsPM2.5 <- subset(SFLocationsPM2.5, `Building Type` == "GP")

SFHospitalsPM2.5 <- subset(SFLocationsPM2.5, `Building Type` == "Hospital")
```

## MSOA Cluster Data for Points
```{r}
# Convert SF objects into SP objects
SPPointCluster <- as(SFMSOA, "Spatial")
SPSchools <- as(SFSchools, "Spatial")
SPGPs <- as(SFGPs, "Spatial")
SPHospitals <- as(SFHospitals, "Spatial")
SPSchoolsNO2 <- as(SFSchoolsNO2, "Spatial")
SPGPsNO2 <- as(SFGPsNO2, "Spatial")
SPHospitalsNO2 <- as(SFHospitalsNO2, "Spatial")
SPSchoolsPM2.5 <- as(SFSchoolsPM2.5, "Spatial")
SPGPsPM2.5 <- as(SFGPsPM2.5, "Spatial")
SPHospitalsPM2.5 <- as(SFHospitalsPM2.5, "Spatial")

# Transform CRS to BNG (a projected CRS).
SPPointCluster <- spTransform(SPPointCluster, BNG)
SPSchools <- spTransform(SPSchools, BNG)
SPGPs <- spTransform(SPGPs, BNG)
SPHospitals <- spTransform(SPHospitals, BNG)
SPSchoolsNO2 <- spTransform(SPSchoolsNO2, BNG)
SPGPsNO2 <- spTransform(SPGPsNO2, BNG)
SPHospitalsNO2 <- spTransform(SPHospitalsNO2, BNG)
SPSchoolsPM2.5 <- spTransform(SPSchoolsPM2.5, BNG)
SPGPsPM2.5 <- spTransform(SPGPsPM2.5, BNG)
SPHospitalsPM2.5 <- spTransform(SPHospitalsPM2.5, BNG)

# Count the number of points in each MSOA.
SPPointCluster@data$SchoolCount <- poly.counts(SPSchools, SPPointCluster)
SPPointCluster@data$GPCount <- poly.counts(SPGPs, SPPointCluster)
SPPointCluster@data$HospitalCount <- poly.counts(SPHospitals, SPPointCluster)
SPPointCluster@data$SchoolNO2Count <- poly.counts(SPSchoolsNO2, SPPointCluster)
SPPointCluster@data$GPNO2Count <- poly.counts(SPGPsNO2, SPPointCluster)
SPPointCluster@data$HospitalNO2Count <- poly.counts(SPHospitalsNO2, SPPointCluster)
SPPointCluster@data$SchoolPM2.5Count <- poly.counts(SPSchoolsPM2.5, SPPointCluster)
SPPointCluster@data$GPPM2.5Count <- poly.counts(SPGPsPM2.5, SPPointCluster)
SPPointCluster@data$HospitalPM2.5Count <- poly.counts(SPHospitalsPM2.5, SPPointCluster)

# Calculate point density.
SPPointCluster@data$SchoolDensity <- round(SPPointCluster@data$SchoolCount/(poly.areas(SPPointCluster)/1000000), digits = 3)
SPPointCluster@data$GPDensity <- round(SPPointCluster@data$GPCount/(poly.areas(SPPointCluster)/1000000), digits = 3)
SPPointCluster@data$HospitalDensity <- round(SPPointCluster@data$HospitalCount/(poly.areas(SPPointCluster)/1000000), digits = 3)
SPPointCluster@data$SchoolNO2Density <- round(SPPointCluster@data$SchoolNO2Count/(poly.areas(SPPointCluster)/1000000), digits = 3)
SPPointCluster@data$GPNO2Density <- round(SPPointCluster@data$GPNO2Count/(poly.areas(SPPointCluster)/1000000), digits = 3)
SPPointCluster@data$HospitalNO2Density <- round(SPPointCluster@data$HospitalNO2Count/ (poly.areas(SPPointCluster)/1000000), digits = 3)
SPPointCluster@data$SchoolPM2.5Density <- round(SPPointCluster@data$SchoolPM2.5Count/ (poly.areas(SPPointCluster)/1000000), digits = 3)
SPPointCluster@data$GPPM2.5Density <- round(SPPointCluster@data$GPPM2.5Count/ (poly.areas(SPPointCluster)/1000000), digits = 3)
SPPointCluster@data$HospitalPM2.5Density <- round(SPPointCluster@data$HospitalPM2.5Count / (poly.areas(SPPointCluster)/1000000), digits = 3)

# Conduct global Moran's I.
GlbMIAllSchool <- moran.test(SPPointCluster@data$SchoolDensity, SpWeightsMSOA)
GlbMIAllGP <- moran.test(SPPointCluster@data$GPDensity, SpWeightsMSOA)
GlbMIAllHospital <- moran.test(SPPointCluster@data$HospitalDensity, SpWeightsMSOA)
GlbMINO2School <- moran.test(SPPointCluster@data$SchoolNO2Density, SpWeightsMSOA)
GlbMINO2GP <- moran.test(SPPointCluster@data$GPNO2Density, SpWeightsMSOA)
GlbMINO2Hospital <- moran.test(SPPointCluster@data$HospitalNO2Density, SpWeightsMSOA)
GlbMIPM2.5School <- moran.test(SPPointCluster@data$SchoolPM2.5Density, SpWeightsMSOA)
GlbMIPM2.5GP <- moran.test(SPPointCluster@data$GPPM2.5Density, SpWeightsMSOA)
GlbMIPM2.5Hospital <- moran.test(SPPointCluster@data$HospitalPM2.5Density, SpWeightsMSOA)

# Conduct local Moran's I.
lclMIAllSchool <- round(localmoran(SPPointCluster@data$SchoolDensity, SpWeightsMSOA), digits = 3)
lclMIAllGP <- round(localmoran(SPPointCluster@data$GPDensity, SpWeightsMSOA), digits = 3)
lclMIAllHospital <- round(localmoran(SPPointCluster@data$HospitalDensity, SpWeightsMSOA), digits = 3)
lclMINO2School <- round(localmoran(SPPointCluster@data$SchoolNO2Density, SpWeightsMSOA), digits = 3)
lclMINO2GP <- round(localmoran(SPPointCluster@data$GPNO2Density, SpWeightsMSOA), digits = 3)
lclMINO2Hospital <- round(localmoran(SPPointCluster@data$HospitalNO2Density, SpWeightsMSOA), digits = 3)
lclMIPM2.5School <- round(localmoran(SPPointCluster@data$SchoolPM2.5Density, SpWeightsMSOA), digits = 3)
lclMIPM2.5GP <- round(localmoran(SPPointCluster@data$GPPM2.5Density, SpWeightsMSOA), digits = 3)
lclMIPM2.5Hospital <- round(localmoran(SPPointCluster@data$HospitalPM2.5Density, SpWeightsMSOA), digits = 3)

# Join local Moran's I Z values to shape file.
SPPointCluster$lclMIAllSchool <- lclMIAllSchool[,4]
SPPointCluster$lclMIAllGP <- lclMIAllGP[,4]
SPPointCluster$lclMIAllHospital <- lclMIAllHospital[,4]
SPPointCluster$lclMINO2School <- lclMINO2School[,4]
SPPointCluster$lclMINO2GP <- lclMINO2GP[,4]
SPPointCluster$lclMINO2Hospital <- lclMINO2Hospital[,4]
SPPointCluster$lclMIPM2.5School <- lclMIPM2.5School[,4]
SPPointCluster$lclMIPM2.5GP <- lclMIPM2.5GP[,4]
SPPointCluster$lclMIPM2.5Hospital <- lclMIPM2.5Hospital[,4]

# Convert SP MSOA data into a data frame.
SFPointCluster <- st_as_sf(SPPointCluster)

# Transform CRS to WGS
SFPointCluster <- st_transform(SFPointCluster, WGS84)

# Rename columns
colnames(SFPointCluster) <- c("MSOA Code", "MSOA Name", "LAD Name", "LAD Code", "Mean NO2 Conc.", "Mean PM2.5 Conc.", "School (All) Count", "GP (All) Count", "Hospital (All) Count", "School (NO2) Count", "GP (NO2) Count", "Hospital (NO2) Count", "School (PM2.5) Count", "GP (PM2.5) Count", "Hospital (PM2.5) Count", "School (All) Density", "GP (All) Density", "Hospital (All) Density", "School (NO2) Density", "GP (NO2) Density", "Hospital (NO2) Density", "School (PM2.5) Density", "GP (PM2.5) Density", "Hospital (PM2.5) Density", "School (All) Moran's I", "GP (All) Moran's I", "Hospital (All) Moran's I", "School (NO2) Moran's I", "GP (NO2) Moran's I", "Hospital (NO2) Moran's I", "School (PM2.5) Moran's I", "GP (PM2.5) Moran's I", "Hospital (PM2.5) Moran's I", "geometry")

# Subset Data
SFPointCluster_SchoolsAll <- SFPointCluster[, c(25, 34)]
SFPointCluster_GPsAll <- SFPointCluster[, c(26, 34)]
SFPointCluster_HospitalsAll <- SFPointCluster[, c(27, 34)]
SFPointCluster_SchoolsNO2 <- SFPointCluster[, c(28, 34)]
SFPointCluster_GPsNO2 <- SFPointCluster[, c(29, 34)]
SFPointCluster_HospitalsNO2 <- SFPointCluster[, c(30, 34)]
SFPointCluster_SchoolsPM2.5 <- SFPointCluster[, c(31, 34)]
SFPointCluster_GPsPM2.5 <- SFPointCluster[, c(32, 34)]
SFPointCluster_HospitalsPM2.5 <- SFPointCluster[, c(33, 34)]

# Rename columns.
colnames(SFPointCluster_SchoolsAll) <- c("Moran's I", "geometry")
colnames(SFPointCluster_GPsAll) <- c("Moran's I", "geometry")
colnames(SFPointCluster_HospitalsAll) <- c("Moran's I", "geometry")
colnames(SFPointCluster_SchoolsNO2) <- c("Moran's I", "geometry")
colnames(SFPointCluster_GPsNO2) <- c("Moran's I", "geometry")
colnames(SFPointCluster_HospitalsNO2) <- c("Moran's I", "geometry")
colnames(SFPointCluster_SchoolsPM2.5) <- c("Moran's I", "geometry")
colnames(SFPointCluster_GPsPM2.5) <- c("Moran's I", "geometry")
colnames(SFPointCluster_HospitalsPM2.5) <- c("Moran's I", "geometry")

# Map Moran's I.
All_Schools_MoransI <- tm_shape(SFPointCluster_SchoolsAll) +
  tm_polygons(col = "Moran's I", 
              palette = PalMi, 
              breaks = BrksMi,
              midpoint = 0)+
  tm_shape(LAD) +
  tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 2.0) +
  tm_shape(MSOA) +
    tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 1.0)+
  tm_layout(aes.palette = list(seq = "-RdYlBu"),
            frame = FALSE)+
  tm_legend(show = FALSE)+
  tm_scale_bar(position = c("left", "bottom"))+
  tm_compass(north = 0, position = c("right", "top"))+
  tm_credits("(a)", position=c(0,0.85), size=1.5)

All_GPs_MoransI <- tm_shape(SFPointCluster_GPsAll) +
  tm_polygons(col = "Moran's I", 
              palette = PalMi, 
              breaks = BrksMi,
              midpoint = 0)+
  tm_shape(LAD) +
  tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 2.0) +
  tm_shape(MSOA) +
    tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 1.0)+
  tm_layout(aes.palette = list(seq = "-RdYlBu"),
            frame = FALSE)+
  tm_legend(show = FALSE)+
  tm_scale_bar(position = c("left", "bottom"))+
  tm_compass(north = 0,
             position = c("right", "top"))+
  tm_credits("(b)", position=c(0,0.85), size=1.5)

All_Hospitals_MoransI <- tm_shape(SFPointCluster_HospitalsAll) +
  tm_polygons(col = "Moran's I", 
              palette = PalMi, 
              breaks = BrksMi,
              midpoint = 0)+
  tm_shape(LAD) +
  tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 2.0) +
  tm_shape(MSOA) +
    tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 1.0)+
  tm_layout(aes.palette = list(seq = "-RdYlBu"),
            frame = FALSE)+
  tm_legend(show = FALSE)+
  tm_scale_bar(position = c("left", "bottom"))+
  tm_compass(north = 0,
             position = c("right", "top"))+
  tm_credits("(c)", position=c(0,0.85), size=1.5)

All_MoransI_Legend <- tm_shape(SFPointCluster_HospitalsAll) +
  tm_polygons(col = "Moran's I", 
              palette = PalMi, 
              breaks = BrksMi,
              midpoint = 0)+
  tm_layout(legend.only = TRUE, legend.position=c(0,0.4),asp=0.1)


All_MoransI <- tmap_arrange(All_Schools_MoransI, All_GPs_MoransI, All_Hospitals_MoransI, All_MoransI_Legend, ncol=2, nrow = 2)
All_MoransI

NO2_Schools_MoransI <- tm_shape(SFPointCluster_SchoolsNO2) +
  tm_polygons(col = "Moran's I", 
              palette = PalMi, 
              breaks = BrksMi,
              midpoint = 0)+
  tm_shape(LAD) +
  tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 2.0) +
  tm_shape(MSOA) +
    tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 1.0)+
  tm_layout(aes.palette = list(seq = "-RdYlBu"),
            frame = FALSE)+
  tm_legend(show = FALSE)+
  tm_scale_bar(position = c("left", "bottom"))+
  tm_compass(north = 0, position = c("right", "top"))+
  tm_credits("(a)", position=c(0,0.85), size=1.5)

NO2_GPs_MoransI <- tm_shape(SFPointCluster_GPsNO2) +
  tm_polygons(col = "Moran's I", 
              palette = PalMi, 
              breaks = BrksMi,
              midpoint = 0)+
  tm_shape(LAD) +
  tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 2.0) +
  tm_shape(MSOA) +
    tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 1.0)+
  tm_layout(aes.palette = list(seq = "-RdYlBu"),
            frame = FALSE)+
  tm_legend(show = FALSE)+
  tm_scale_bar(position = c("left", "bottom"))+
  tm_compass(north = 0,
             position = c("right", "top"))+
  tm_credits("(b)", position=c(0,0.85), size=1.5)

NO2_Hospitals_MoransI <- tm_shape(SFPointCluster_HospitalsNO2) +
  tm_polygons(col = "Moran's I", 
              palette = PalMi, 
              breaks = BrksMi,
              midpoint = 0)+
  tm_shape(LAD) +
  tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 2.0) +
  tm_shape(MSOA) +
    tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 1.0)+
  tm_layout(aes.palette = list(seq = "-RdYlBu"),
            frame = FALSE)+
  tm_legend(show = FALSE)+
  tm_scale_bar(position = c("left", "bottom"))+
  tm_compass(north = 0,
             position = c("right", "top"))+
  tm_credits("(c)", position=c(0,0.85), size=1.5)

NO2_MoransI_Legend <- tm_shape(SFPointCluster_SchoolsNO2) +
  tm_polygons(col = "Moran's I", 
              palette = PalMi, 
              breaks = BrksMi,
              midpoint = 0)+
  tm_layout(legend.only = TRUE, legend.position=c(0,0.4),asp=0.1)

NO2_MoransI <- tmap_arrange(NO2_Schools_MoransI, NO2_GPs_MoransI, NO2_Hospitals_MoransI, NO2_MoransI_Legend, ncol=2, nrow = 2)
NO2_MoransI

# Save Maps of Moran's I.
tmap_save(All_MoransI, 'Results/All_MoransI.png', units = "in", height = 5.59, width = 6.59)
tmap_save(NO2_MoransI, 'Results/NO2_MoransI.png', units = "in", height = 5.59, width = 6.59)


```

# Research Question 3

## Index of Multiple Deprivation 
```{r}
# Read in indices of deprivation data.
IDData <- read_csv("Data/Boundaries and Census/ID 2019 for London.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
# Merge ID data to location data.
IDData<-merge(IDData, 
             SFLSOA, 
             by.x="LSOA code (2011)", 
             by.y="LSOA Code",
             no.dups = TRUE,
             all.x = TRUE)

# Extract relevent columns.
IDData <- IDData[,c(1, 31, 33, 5)]

# Rename columns.
colnames(IDData) <- c("LSOA Code", "MSOA Code", "LAD Code", "IMD Score")

# Aggregate IDM scores to MSOA and LADs.
IDLSOA <- IDData[,c(1, 4)]
IDMSOA <- aggregate(IDData[, 4], by = list(IDData$`MSOA Code`), FUN = mean)
IDLAD <- aggregate(IDData[, 4], by = list(IDData$`LAD Code`), FUN = mean)
IDMSOA[, 2] <- round(IDMSOA[, 2], digits = 3)
IDLAD[, 2] <- round(IDLAD[, 2], digits = 3)
colnames(IDMSOA) <- c("MSOA Code", "IMD Score")
colnames(IDLAD) <- c("LAD Code", "IMD Score")

# Merge ID data to boundaries.
SFLAD<-merge(SFLAD, 
             IDLAD, 
             by.x="LAD Code", 
             by.y="LAD Code",
             no.dups = TRUE,
             all.x = TRUE)
SFMSOA<-merge(SFMSOA, 
             IDMSOA, 
             by.x="MSOA Code", 
             by.y="MSOA Code",
             no.dups = TRUE,
             all.x = TRUE)
SFLSOA<-merge(SFLSOA, 
             IDLSOA, 
             by.x="LSOA Code", 
             by.y="LSOA Code",
             no.dups = TRUE,
             all.x = TRUE)
```

## Road Density
```{r}
# Load road shapefile.
Roads <- st_read("Data/Air Pollution/LAEI 2016 Supporting Information/LAEI_MajorRoadNetwork_Link.shp")

# Tranform into an SF object.
SFRoads <- st_as_sf(Roads)

# Transform into BNG.
SFRoads <- st_transform(SFRoads, BNG)

# Select relevent columns.
SFRoads <- SFRoads[,c(6, 9, 25)]

# Rename columns.
colnames(SFRoads) <- c("Road Type", "Road Nature", "geometry")

# Copy and tranform MSOA SF into BNG
RoadsMSOA <- st_transform(SFMSOA, BNG)

# Run intersection.
RoadsMSOA <- st_intersection(SFRoads, RoadsMSOA)

# Determine road lengths.
RoadsMSOA$`Road Length (km)` <- st_length(RoadsMSOA)/1000

# Aggregate road lengths.
RoadsMSOA <- aggregate(RoadsMSOA$`Road Length (km)`, by = list(RoadsMSOA$MSOA.Code), FUN = sum)

# Rename columns.
colnames(RoadsMSOA) <- c("MSOA Code", "Road Length (km)")

# Determine road density.
RoadsMSOA$`Road Density (km/km2)` <- round(as.numeric(RoadsMSOA$`Road Length (km)` / (st_area(SFMSOA) /1000000)), digits = 2)

# Round lengths.
RoadsMSOA[, 2] <- round(as.numeric(RoadsMSOA[, 2]), digits = 2)

# Merge road length with MSOA.
SFMSOA<-merge(SFMSOA, 
             RoadsMSOA, 
             by.x="MSOA Code", 
             by.y="MSOA Code",
             no.dups = TRUE,
             all.x = TRUE)
```

## Distance from Central London (Charing Cross)
```{r}
# Create Postcode vector with Charing Cross postcode.
Postcode <- "WC2N5DU"

# Convert object to dataframe.
CharingCross <- data.frame(Postcode)

# Join code points.
CharingCross<-merge(CharingCross, 
             AllCodePoints, 
             by.x="Postcode", 
             by.y="Postcode",
             no.dups = TRUE)

# Convert Charing Cross to SF.
CharingCross <- st_as_sf(CharingCross, coords = c("Eastings", "Northings"), crs = BNG)

# Get SF MSOA Codes.
SFCentroidMSOA <- data.frame(SFMSOA$`MSOA Code`)

# Set MSOA centroids.
SFCentroidMSOA[,2:3] <- coordinates(SPPointCluster)

# Change column names.
colnames(SFCentroidMSOA) <- c("MSOA Code", "Eastings", "Northings")

# Convert to SF.
SFCentroidMSOA <- st_as_sf(SFCentroidMSOA, coords = c("Eastings", "Northings"), crs = BNG)

# Determine distance of MSOA centroids to Charing Cross.
SFCentroidMSOA$`Dist. from C. London (km)` <- round(as.numeric(st_distance(SFCentroidMSOA$geometry, CharingCross)/1000), digits = 2)

# Remove geometry.
st_geometry(SFCentroidMSOA) <- NULL

# Join to SFMSOA.
SFMSOA<-merge(SFMSOA, 
             SFCentroidMSOA, 
             by.x="MSOA Code", 
             by.y="MSOA Code",
             no.dups = TRUE,
             all.x = TRUE)
```

## Linear Regression Model
```{r}
# Conduct linear regression.
LRNO2 <- lm(`Mean NO2 Conc.` ~ `IMD Score` + `Road Density (km/km2)` + `Dist. from C. London (km)`, data = SFMSOA)
LRPM2.5 <- lm(`Mean PM2.5 Conc.` ~ `IMD Score` + `Road Density (km/km2)` + `Dist. from C. London (km)`, data = SFMSOA)

# Summarise data.
summary(LRNO2)
summary(LRPM2.5)

# Extract linear regression results.
LRResultsNO2 <- tidy(LRNO2)
LRResultsPM2.5 <- tidy(LRPM2.5)

```

## Linear Regression - Assumption 1
```{r}
# Plot histogram on variables.
ggplot(SFMSOA, aes(x=`Mean NO2 Conc.`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 1) + 
  geom_density(colour="red", size=1, adjust=1)
ggplot(SFMSOA, aes(x=`Mean PM2.5 Conc.`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 0.1) + 
  geom_density(colour="red", size=1, adjust=1)
ggplot(SFMSOA, aes(x=`IMD Score`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 1) + 
  geom_density(colour="red", size=1, adjust=1)
ggplot(SFMSOA, aes(x=`Road Density (km/km2)`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 1) + 
  geom_density(colour="red", size=1, adjust=1)
ggplot(SFMSOA, aes(x=`Dist. from C. London (km)`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 1) + 
  geom_density(colour="red", size=1, adjust=1)

# Plot Scatter plot
qplot(x = `Mean NO2 Conc.`, y = `IMD Score`, data = SFMSOA)
qplot(x = `Mean NO2 Conc.`, y = `Road Density (km/km2)`, data = SFMSOA)
qplot(x = `Mean NO2 Conc.`, y = `Dist. from C. London (km)`, data = SFMSOA)
```

## Linear Regression - Assumption 2
```{r}
# Plot linear regression model residuals in a histogram.
qplot(LRNO2$residuals) + geom_histogram() 
qplot(LRPM2.5$residuals) + geom_histogram() 
```

## Linear Regression - Assumption 3
```{r}
# Remove geometry of SFMSOA.
CorMSOA <- st_set_geometry(SFMSOA,NULL)

# Extract dependent varaiables
CorMSOA <- CorMSOA[,c("IMD Score", "Road Density (km/km2)", "Dist. from C. London (km)")]

# Calculate correlation matrix.
CorMSOA <- cor(CorMSOA, use="complete.obs", method="pearson")

# Plot correlation matrix.
corrplot(CorMSOA, type = "lower")

# Calculate VIF.
vif(LRNO2)
vif(LRPM2.5)
```

## Linear Regression - Assumption 4
```{r}
# Plot model diagnostics.
plot(LRNO2)
plot(LRPM2.5)

```

## Linear Regression - Assumption 5
```{r}
# Merge model residuals to shapefile.
SFMSOA$`LRNO2 Residuals` <- LRNO2$residuals
SFMSOA$`LRPM2.5 Residuals` <- LRPM2.5$residuals

# Map model residuals.
tm_shape(SFMSOA) +
  tm_polygons("LRNO2 Residuals", palette = "RdYlBu")
tm_shape(SFMSOA) +
  tm_polygons("LRPM2.5 Residuals", palette = "RdYlBu")

# Convert SF objects to SP objects.
SPMSOA <- as(SFMSOA, "Spatial")

# Run Moran's I on residuals.
moran.test(SPMSOA@data$LRNO2.Residuals, SpWeightsMSOA)
moran.test(SPMSOA@data$LRPM2.5.Residuals, SpWeightsMSOA)

```

## GWR
```{r}
# Calculate kernel bandwidths.
GWRbandwidthNO2 <- gwr.sel(`Mean NO2 Conc.` ~ `IMD Score` + `Road Density (km/km2)` +`Dist. from C. London (km)`, data = SFMSOA, coords=CentroidMSOA, adapt=T)
GWRbandwidthPM2.5 <- gwr.sel(`Mean PM2.5 Conc.` ~ `IMD Score` + `Road Density (km/km2)` + `Dist. from C. London (km)`, data = SFMSOA, coords=CentroidMSOA, adapt=T)

# Run the GWR model.
GWRNO2 = gwr(`Mean NO2 Conc.` ~ `IMD Score` + `Road Density (km/km2)` + `Dist. from C. London (km)`, data = SFMSOA, coords=CentroidMSOA, adapt=GWRbandwidthNO2, hatmatrix=TRUE, se.fit=TRUE)
GWRPM2.5 = gwr(`Mean PM2.5 Conc.` ~ `IMD Score` + `Road Density (km/km2)` + `Dist. from C. London (km)`, data = SFMSOA, coords=CentroidMSOA, adapt=GWRbandwidthNO2, hatmatrix=TRUE, se.fit=TRUE)

# Save the results.
GWRNO2Results <- as.data.frame(GWRNO2$SDF)
GWRPM2.5Results <- as.data.frame(GWRPM2.5$SDF)

# Merge coefficients with shapefiles.
SFMSOA$`IMD NO2 Coef.`<- round(GWRNO2Results$X.IMD.Score., digits = 3)
SFMSOA$`Road Density NO2 Coef.`<- round(GWRNO2Results$X.Road.Density..km.km2.., digits = 3)
SFMSOA$`Dist. from C. London NO2 Coef.`<- round(GWRNO2Results$X.Dist..from.C..London..km.., digits = 3)

SFMSOA$`IMD PM2.5 Coef.`<- round(GWRPM2.5Results$X.IMD.Score., digits = 3)
SFMSOA$`Road Density PM2.5 Coef.`<- round(GWRPM2.5Results$X.Road.Density..km.km2.., digits = 3)
SFMSOA$`Dist. from C. London PM2.5 Coef.`<- round(GWRPM2.5Results$X.Dist..from.C..London..km.., digits = 3)

# Map coefficients.
NO2_IMD_Coef <- tm_shape(SFMSOA) +
  tm_polygons(col = "IMD NO2 Coef.", 
              palette = "RdBu",
              midpoint = 0)+
  tm_shape(LAD) +
  tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 2.0) +
  tm_shape(MSOA) +
    tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 1.0)+
  tm_layout(legend.outside = TRUE,
            legend.outside.position = "right",
            frame = FALSE)+
  tm_scale_bar(position = c("left", "bottom"))+
  tm_compass(north = 0, position = c("right", "top"))+
  tm_credits("(a)", position=c(0,0.85), size=1.5)

NO2_RD_Coef <- tm_shape(SFMSOA) +
  tm_polygons(col = "Road Density NO2 Coef.", 
              palette = "RdBu",
              midpoint = 0)+
  tm_shape(LAD) +
  tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 2.0) +
  tm_shape(MSOA) +
    tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 1.0)+
  tm_layout(legend.outside = TRUE,
            legend.outside.position = "right",
            frame = FALSE)+
  tm_scale_bar(position = c("left", "bottom"))+
  tm_compass(north = 0, position = c("right", "top"))+
  tm_credits("(b)", position=c(0,0.85), size=1.5)

NO2_DfCL_Coef <- tm_shape(SFMSOA) +
  tm_polygons(col = "Dist. from C. London NO2 Coef.", 
              palette = "RdBu",
              midpoint = 0)+
  tm_shape(LAD) +
  tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 2.0) +
  tm_shape(MSOA) +
    tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 1.0)+
  tm_layout(legend.outside = TRUE,
            legend.outside.position = "right",
            frame = FALSE)+
  tm_scale_bar(position = c("left", "bottom"))+
  tm_compass(north = 0, position = c("right", "top"))+
  tm_credits("(c)", position=c(0,0.85), size=1.5)

NO2_Coef <- tmap_arrange(NO2_IMD_Coef, NO2_RD_Coef, NO2_DfCL_Coef, ncol=1, nrow = 3)
NO2_Coef

PM2.5_IMD_Coef <- tm_shape(SFMSOA) +
  tm_polygons(col = "IMD PM2.5 Coef.", 
              palette = "RdBu",
              midpoint = 0)+
  tm_shape(LAD) +
  tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 2.0) +
  tm_shape(MSOA) +
    tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 1.0)+
  tm_layout(legend.outside = TRUE,
            legend.outside.position = "right",
            frame = FALSE)+
  tm_scale_bar(position = c("left", "bottom"))+
  tm_compass(north = 0, position = c("right", "top"))+
  tm_credits("(a)", position=c(0,0.85), size=1.5)

PM2.5_RD_Coef <- tm_shape(SFMSOA) +
  tm_polygons(col = "Road Density PM2.5 Coef.", 
              palette = "RdBu",
              midpoint = 0)+
  tm_shape(LAD) +
  tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 2.0) +
  tm_shape(MSOA) +
    tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 1.0)+
  tm_layout(legend.outside = TRUE,
            legend.outside.position = "right",
            frame = FALSE)+
  tm_scale_bar(position = c("left", "bottom"))+
  tm_compass(north = 0, position = c("right", "top"))+
  tm_credits("(b)", position=c(0,0.85), size=1.5)

PM2.5_DfCL_Coef <- tm_shape(SFMSOA) +
  tm_polygons(col = "Dist. from C. London PM2.5 Coef.", 
              palette = "RdBu",
              midpoint = 0)+
  tm_shape(LAD) +
  tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 2.0) +
  tm_shape(MSOA) +
    tm_polygons(col = NA, alpha = 0, border.col = "black", lwd = 1.0)+
  tm_layout(legend.outside = TRUE,
            legend.outside.position = "right",
            frame = FALSE)+
  tm_scale_bar(position = c("left", "bottom"))+
  tm_compass(north = 0, position = c("right", "top"))+
  tm_credits("(c)", position=c(0,0.85), size=1.5)


PM2.5_Coef <- tmap_arrange(PM2.5_IMD_Coef, PM2.5_RD_Coef, PM2.5_DfCL_Coef, ncol=1, nrow = 3)
PM2.5_Coef

# Save Maps of GWR Coef.
tmap_save(NO2_Coef, 'Results/NO2_Coef.png', units = "in", height = 5.59, width = 6.59)
tmap_save(PM2.5_Coef, 'Results/PM2.5_Coef.png', units = "in", height = 5.59, width = 6.59)

```

# Leaflet Popups and Palettes

## Popup Tables and Palettes For Area Data
```{r}
# Create copies of the MSOA data.
PopArea <- SFMSOA

# Remove geometry data.
st_geometry(PopArea) <- NULL

# Create popup tables.
PopNO2 <- popupTable(PopArea, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "Mean NO2 Conc."))
PopPM2.5 <- popupTable(PopArea, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "Mean PM2.5 Conc."))

# Create palettes.
PalNO2 <- colorBin("RdYlBu", reverse = TRUE, domain = PopArea$`Mean NO2 Conc.`, bins = c(0, 10, 20, 30, 40, 50, 60, 70, 80))
PalPM2.5 <- colorBin("RdYlBu", reverse = TRUE, domain = PopArea$`Mean PM2.5 Conc.`, bins = c(0, 2.5, 5.0, 7.5, 10, 12.5, 15.0, 17.5, 20))

```

## Popup Tables and Palettes For MSOA Area Cluster Data
```{r}
# Create copies of the MSOA data.
PopAreaCluster <- SFAreaCluster

# Remove geometry data.
st_geometry(PopAreaCluster) <- NULL

# Create popup tables.
PopNO2Cluster <- popupTable(PopAreaCluster, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "Mean NO2 Conc.", "NO2 Getis Ord G"))
PopPM2.5Cluster <- popupTable(PopAreaCluster, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "Mean PM2.5 Conc.", "PM2.5 Getis Ord G"))

# Create palettes.
PalNO2Cluster <- colorBin(PalMi, domain = PopAreaCluster$`NO2 Getis Ord G`, bins = BrksMi)
PalPM2.5Cluster <- colorBin(PalMi, domain = PopAreaCluster$`PM2.5 Getis Ord G`, bins = BrksMi)

```

## Popup Tables and Palettes For Point Data
```{r}
# Create copies of the point data.
PopLADBry <- SFLAD
PopMSOABry <- SFMSOA
PopLSOABry <- SFLSOA
PopSchools <- SFSchools
PopGPs <- SFGPs
PopHospitals <- SFHospitals
PopSchoolsNO2 <- SFSchoolsNO2
PopGPsNO2 <- SFGPsNO2
PopHospitalsNO2 <- SFHospitalsNO2
PopSchoolsPM2.5 <- SFSchoolsPM2.5
PopGPsPM2.5 <- SFGPsPM2.5
PopHospitalsPM2.5 <- SFHospitalsPM2.5

# Remove geometry data.
st_geometry(PopLADBry) <- NULL
st_geometry(PopMSOABry) <- NULL
st_geometry(PopLSOABry) <- NULL
st_geometry(PopSchools) <- NULL
st_geometry(PopGPs) <- NULL
st_geometry(PopHospitals) <- NULL
st_geometry(PopSchoolsNO2) <- NULL
st_geometry(PopGPsNO2) <- NULL
st_geometry(PopHospitalsNO2) <- NULL
st_geometry(PopSchoolsPM2.5) <- NULL
st_geometry(PopGPsPM2.5) <- NULL
st_geometry(PopHospitalsPM2.5) <- NULL

# Create popup tables.
PopLADBry <- popupTable(PopLADBry, feature.id = FALSE, row.numbers = FALSE, zcol=c("LAD Name", "LAD Code"))
PopMSOABry <- popupTable(PopMSOABry, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "MSOA Code", "LAD Name", "LAD Code"))
PopLSOABry <- popupTable(PopLSOABry, feature.id = FALSE, row.numbers = FALSE, zcol=c("LSOA Name", "LSOA Code", "MSOA Name", "MSOA Code", "LAD Name", "LAD Code"))
PopSchools <- popupTable(PopSchools, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))
PopGPs <- popupTable(PopGPs, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))
PopHospitals <- popupTable(PopHospitals, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))
PopSchoolsNO2 <- popupTable(PopSchoolsNO2, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))
PopGPsNO2 <- popupTable(PopGPsNO2, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))
PopHospitalsNO2 <- popupTable(PopHospitalsNO2, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))
PopSchoolsPM2.5 <- popupTable(PopSchoolsPM2.5, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))
PopGPsPM2.5 <- popupTable(PopGPsPM2.5, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))
PopHospitalsPM2.5 <- popupTable(PopHospitalsPM2.5, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))

# Create colour palettes.
PalAll <- colorFactor(c("LightSkyBlue", "RoyalBlue", "LightGreen"), levels = c("GP", "Hospital", "School"))
PalWHO <- colorFactor(c("Orange", "Red", "Gold"), levels = c("GP", "Hospital", "School"))
```

## Popup Tables and Palettes For Point Cluster Data
```{r}
# Create copies of the MSOA data.
PopPointCluster <- SFPointCluster

# Remove geometry data.
st_geometry(PopPointCluster) <- NULL

# Create popup tables.
PopSchoolsCluster <- popupTable(PopPointCluster, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "School (All) Count", "School (All) Density", "School (All) Moran's I"))
PopGPsCluster <- popupTable(PopPointCluster, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "GP (All) Count", "GP (All) Density", "GP (All) Moran's I"))
PopHospitalsCluster <- popupTable(PopPointCluster, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "Hospital (All) Count", "Hospital (All) Density", "Hospital (All) Moran's I"))
PopSchoolsNO2Cluster <- popupTable(PopPointCluster, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "School (NO2) Count", "School (NO2) Density", "School (NO2) Moran's I"))
PopGPsNO2Cluster <- popupTable(PopPointCluster, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "GP (NO2) Count", "GP (NO2) Density", "GP (NO2) Moran's I"))
PopHospitalsNO2Cluster <- popupTable(PopPointCluster, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "Hospital (NO2) Count", "Hospital (NO2) Density", "Hospital (NO2) Moran's I"))
PopSchoolsPM2.5Cluster <- popupTable(PopPointCluster, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "School (PM2.5) Count", "School (PM2.5) Density", "School (PM2.5) Moran's I"))
PopGPsPM2.5Cluster <- popupTable(PopPointCluster, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "GP (PM2.5) Count", "GP (PM2.5) Density", "GP (PM2.5) Moran's I"))
PopHospitalsPM2.5Cluster <- popupTable(PopPointCluster, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "Hospital (PM2.5) Count", "Hospital (PM2.5) Density", "Hospital (PM2.5) Moran's I"))

# Create palettes.
PalSchoolsCluster <- colorBin(PalMi, domain = PopPointCluster$`School (All) Moran's I`, bins = BrksMi)
PalGPsCluster <- colorBin(PalMi, domain = PopPointCluster$`GP (All) Moran's I`, bins = BrksMi)
PalHospitalsCluster <- colorBin(PalMi, domain = PopPointCluster$`Hospital (All) Moran's I`, bins = BrksMi)
PalSchoolsNO2Cluster <- colorBin(PalMi, domain = PopPointCluster$`School (NO2) Moran's I`, bins = BrksMi)
PalGPsNO2Cluster <- colorBin(PalMi, domain = PopPointCluster$`GP (NO2) Moran's I`, bins = BrksMi)
PalHospitalsNO2Cluster <- colorBin(PalMi, domain = PopPointCluster$`Hospital (NO2) Moran's I`, bins = BrksMi)
PalSchoolsPM2.5Cluster <- colorBin(PalMi, domain = PopPointCluster$`School (PM2.5) Moran's I`, bins = BrksMi)
PalGPsPM2.5Cluster <- colorBin(PalMi, domain = PopPointCluster$`GP (PM2.5) Moran's I`, bins = BrksMi)
PalHospitalsPM2.5Cluster <- colorBin(PalMi, domain = PopPointCluster$`Hospital (PM2.5) Moran's I`, bins = BrksMi)
```

## Popup Tables and Palettes For MSOA LR Data
```{r}
# Create popup tables.
PopIMDScore <- popupTable(PopArea, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "IMD Score"))
PopRoadDensity <- popupTable(PopArea, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "Road Length (km)"))
PopDistCLondon <- popupTable(PopArea, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "Dist. from C. London (km)"))

# Create palettes.
PalIMDScore <- colorBin("YlOrBr", domain = PopArea$`IMD Score`, bins = c(0, 10, 20, 30, 40, 50, 60))
PalRoadDensity <- colorBin("YlOrBr", domain = PopArea$`Road Density (km/km2)`, bins = c(0, 2, 4, 6, 8, 10, 12, 14))
PalDistCLondon <- colorBin("YlOrBr", domain = PopArea$`Dist. from C. London (km)`, bins = c(0, 5, 10, 15, 20, 25, 30))

```

## Popup Tables and Palettes For MSOA GWR Data
```{r}
# Create popup tables.
PopIMDScoreNO2 <- popupTable(PopArea, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "IMD NO2 Coef."))
PopIMDScorePM2.5 <- popupTable(PopArea, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "Mean PM2.5 Conc.", "IMD PM2.5 Coef."))
PopRoadDensityNO2 <- popupTable(PopArea, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "Road Density NO2 Coef."))
PopRoadDensityPM2.5 <- popupTable(PopArea, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "Road Density PM2.5 Coef."))
PopDistCLondonNO2 <- popupTable(PopArea, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "Dist. from C. London NO2 Coef."))
PopDistCLondonPM2.5 <- popupTable(PopArea, feature.id = FALSE, row.numbers = FALSE, zcol=c("MSOA Name", "Dist. from C. London PM2.5 Coef."))

# Create palettes.
PalIMDScoreNO2 <- colorBin("RdBu", domain = PopArea$`IMD NO2 Coef.`, bins = c(-0.20, -0.15, -0.10, -0.05, 0.00, 0.05, 0.10, 0.15))
PalIMDScorePM2.5 <- colorBin("RdBu", domain = PopArea$`IMD PM2.5 Coef.`, bins = c(-0.03, -0.02, -0.01, 0.00, 0.01, 0.02, 0.03))
PalRoadDensityNO2 <- colorBin("Blues", domain = PopArea$`Road Density NO2 Coef.`, bins = c(-0.2, 0.0, 0.2, 0.4, 0.6, 0.8, 1.0, 1.2, 1.4))
PalRoadDensityPM2.5 <- colorBin("Blues", domain = PopArea$`Road Density PM2.5 Coef.`, bins = c(-0.05, 0.00, 0.05, 0.10, 0.15, 0.20))
PalDistCLondonNO2 <- colorBin("Reds", reverse = TRUE, domain = PopArea$`Dist. from C. London NO2 Coef.`, bins = c(-3.0, -2.5, -2.0, -1.5, -1.0, -0.5, 0.0, 0.5))
PalDistCLondonPM2.5 <- colorBin("Reds", reverse = TRUE, domain = PopArea$`Dist. from C. London PM2.5 Coef.`, bins = c(-0.7, -0.6, -0.5, -0.4, -0.3, -0.2, -0.1, 0.0))
```

# Leaflet Interactive Map
```{r}
# Map using leaflet.
MapLeaflet <- leaflet() %>% 
  addTiles(group = "OSM (default)") %>% 
  addProviderTiles(providers$Stamen.Toner, group = "Toner") %>%
  addProviderTiles(providers$CartoDB.Positron, group = "CartoDB")%>%
  setView(-0.10, 51.5, zoom = 10) %>% 
  
  
  
  
  
  
# Boundaries
  addPolygons(data = SFLAD, 
              fill = "transparent", 
              color = "black",
              stroke = "black",
              weight = 2, 
              opacity = 1.0, 
              fillOpacity = 0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 3,bringToFront = FALSE),
              popup = PopLADBry,
              group = "LAD"
              ) %>% 
  addPolygons(data = SFMSOA, 
              fill = "transparent",
              color = "black",
              stroke = "black", 
              weight = 1.0, 
              opacity = 1.0, 
              fillOpacity = 0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = FALSE),
              popup = PopMSOABry,
              group = "MSOA"
              ) %>% 
  addPolygons(data = SFLSOA, 
              fill = "transparent",
              color = "black",
              stroke = "black", 
              weight = 0.5, 
              opacity = 1.0, 
              fillOpacity = 0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = FALSE),
              popup = PopLSOABry,
              group = "LSOA"
              ) %>% 

  
  
  
  # MSOA Area Data. 
  addPolygons(data = SFMSOA, 
              fillColor = ~PalNO2(`Mean NO2 Conc.`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopNO2,
              group = "Mean NO2 Conc."
              ) %>% 
  addPolygons(data = SFMSOA, 
              fillColor = ~PalPM2.5(`Mean PM2.5 Conc.`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopPM2.5,
              group = "Mean PM2.5 Conc."
              ) %>% 
  
  
  
  
  
# MSOA Area Cluster Results. 
  addPolygons(data = SFAreaCluster, 
              fillColor = ~PalNO2Cluster(`NO2 Getis Ord G`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopNO2Cluster,
              group = "NO2 Getis Ord G"
              ) %>% 
  addPolygons(data = SFAreaCluster, 
              fillColor = ~PalPM2.5Cluster(`PM2.5 Getis Ord G`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopPM2.5Cluster,
              group = "PM2.5 Getis Ord G"
              ) %>% 
  

  
  
  
  # Point Data.
  addCircleMarkers(data = SFSchools,
             radius = 5,
             fillColor = ~PalAll(`Building Type`),
             fillOpacity = 1.0,
             stroke = TRUE,
             color = "black",
             opacity = 1.0,
             weight = 1.0,
             popup = PopSchools,
             group = "Schools (All)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'LightGreen'
                } else if (childCount < 100) {  
                  c = 'LightGreen'  
                } else { 
                  c = 'LightGreen'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = SFGPs,
             radius = 5,
             fillColor = ~PalAll(`Building Type`),
             fillOpacity = 1.0,
             stroke = TRUE,
             color = "black",
             opacity = 1.0,
             weight = 1.0,
             popup = PopGPs,
             group = "GPs (All)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'LightSkyBlue'
                } else if (childCount < 100) {  
                  c = 'LightSkyBlue'  
                } else { 
                  c = 'LightSkyBlue'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = SFHospitals,
             radius = 5,
             fillColor = ~PalAll(`Building Type`),
             fillOpacity = 1.0,
             stroke = TRUE,
             color = "black",
             opacity = 1.0,
             weight = 1.0,
             popup = PopHospitals,
             group = "Hospitals (All)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'RoyalBlue'
                } else if (childCount < 100) {  
                  c = 'RoyalBlue'  
                } else { 
                  c = 'RoyalBlue'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = SFSchoolsNO2,
             radius = 5,
             fillColor = ~PalWHO(`Building Type`),
             fillOpacity = 1.0,
             stroke = TRUE,
             color = "black",
             opacity = 1.0,
             weight = 1.0,
             popup = PopSchoolsNO2,
             group = "Schools (NO2)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'Gold'
                } else if (childCount < 100) {  
                  c = 'Gold'  
                } else { 
                  c = 'Gold'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = SFGPsNO2,
             radius = 5,
             fillColor = ~PalWHO(`Building Type`),
             fillOpacity = 1.0,
             stroke = TRUE,
             color = "black",
             opacity = 1.0,
             weight = 1.0,
             popup = PopGPsNO2,
             group = "GPs (NO2)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'Orange'
                } else if (childCount < 100) {  
                  c = 'Orange'  
                } else { 
                  c = 'Orange'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = SFHospitalsNO2,
             radius = 5,
             fillColor = ~PalWHO(`Building Type`),
             fillOpacity = 1.0,
             stroke = TRUE,
             color = "black",
             opacity = 1.0,
             weight = 1.0,
             popup = PopHospitalsNO2,
             group = "Hospitals (NO2)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'Red'
                } else if (childCount < 100) {  
                  c = 'Red'  
                } else { 
                  c = 'Red'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = SFSchoolsPM2.5,
             radius = 5,
             fillColor = ~PalWHO(`Building Type`),
             fillOpacity = 1.0,
             stroke = TRUE,
             color = "black",
             opacity = 1.0,
             weight = 1.0,
             popup = PopSchoolsPM2.5,
             group = "Schools (PM2.5)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'Gold'
                } else if (childCount < 100) {  
                  c = 'Gold'  
                } else { 
                  c = 'Gold'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = SFGPsPM2.5,
             radius = 5,
             fillColor = ~PalWHO(`Building Type`),
             fillOpacity = 1.0,
             stroke = TRUE,
             color = "black",
             opacity = 1.0,
             weight = 1.0,
             popup = PopGPsPM2.5,
             group = "GPs (PM2.5)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'Orange'
                } else if (childCount < 100) {  
                  c = 'Orange'  
                } else { 
                  c = 'Orange'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = SFHospitalsPM2.5,
             radius = 5,
             fillColor = ~PalWHO(`Building Type`),
             fillOpacity = 1.0,
             stroke = TRUE,
             color = "black",
             opacity = 1.0,
             weight = 1.0,
             popup = PopHospitalsPM2.5,
             group = "Hospitals (PM2.5)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'Red'
                } else if (childCount < 100) {  
                  c = 'Red'  
                } else { 
                  c = 'Red'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className:  'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  
  
  
  
  
# MSOA Point Cluster Results. 
  addPolygons(data = SFPointCluster, 
              fillColor = ~PalSchoolsCluster(`School (All) Moran's I`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopSchoolsCluster,
              group = "Schools (All) Moran's I"
              ) %>% 
  addPolygons(data = SFPointCluster, 
              fillColor = ~PalGPsCluster(`GP (All) Moran's I`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopGPsCluster,
              group = "GPs (All) Moran's I"
              ) %>% 
  addPolygons(data = SFPointCluster, 
              fillColor = ~PalHospitalsCluster(`Hospital (All) Moran's I`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopHospitalsCluster,
              group = "Hospitals (All) Moran's I"
              ) %>% 
  addPolygons(data = SFPointCluster, 
              fillColor = ~PalSchoolsNO2Cluster(`School (NO2) Moran's I`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopSchoolsNO2Cluster,
              group = "Schools (NO2) Moran's I"
              ) %>% 
  addPolygons(data = SFPointCluster, 
              fillColor = ~PalGPsNO2Cluster(`GP (NO2) Moran's I`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopGPsNO2Cluster,
              group = "GPs (NO2) Moran's I"
              ) %>% 
  addPolygons(data = SFPointCluster, 
              fillColor = ~PalHospitalsNO2Cluster(`Hospital (NO2) Moran's I`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopHospitalsNO2Cluster,
              group = "Hospitals (NO2) Moran's I"
              ) %>% 
  addPolygons(data = SFPointCluster, 
              fillColor = ~PalSchoolsPM2.5Cluster(`School (PM2.5) Moran's I`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopSchoolsPM2.5Cluster,
              group = "Schools (PM2.5) Moran's I"
              ) %>% 
  addPolygons(data = SFPointCluster, 
              fillColor = ~PalGPsPM2.5Cluster(`GP (PM2.5) Moran's I`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopGPsPM2.5Cluster,
              group = "GPs (PM2.5) Moran's I"
              ) %>% 
  addPolygons(data = SFPointCluster, 
              fillColor = ~PalHospitalsPM2.5Cluster(`Hospital (PM2.5) Moran's I`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopHospitalsPM2.5Cluster,
              group = "Hospitals (PM2.5) Moran's I"
              ) %>% 
  
  
  
  

# MSOA LR Data.
  addPolygons(data = SFMSOA, 
              fillColor = ~PalIMDScore(`IMD Score`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopIMDScore,
              group = "IMD Score"
              ) %>% 
  addPolygons(data = SFMSOA, 
              fillColor = ~PalRoadDensity(`Road Density (km/km2)`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopRoadDensity,
              group = "Road Density (km/km2)"
              ) %>% 
  addPolygons(data = SFMSOA, 
              fillColor = ~PalDistCLondon(`Dist. from C. London (km)`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopDistCLondon,
              group = "Dist. from C. London (km)"
              ) %>% 

  
  
  
  
# MSOA GWR Results
  addPolygons(data = SFMSOA, 
              fillColor = ~PalIMDScoreNO2(`IMD NO2 Coef.`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopIMDScoreNO2,
              group = "IMD NO2 Coef."
              ) %>% 
  addPolygons(data = SFMSOA, 
              fillColor = ~PalIMDScorePM2.5(`IMD PM2.5 Coef.`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopIMDScorePM2.5,
              group = "IMD PM2.5 Coef."
              ) %>% 
  addPolygons(data = SFMSOA, 
              fillColor = ~PalRoadDensityNO2(`Road Density NO2 Coef.`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopRoadDensityNO2,
              group = "Road Density NO2 Coef."
              ) %>% 
  addPolygons(data = SFMSOA, 
              fillColor = ~PalRoadDensityPM2.5(`Road Density PM2.5 Coef.`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopRoadDensityPM2.5,
              group = "Road Density PM2.5 Coef."
              ) %>% 
  addPolygons(data = SFMSOA, 
              fillColor = ~PalDistCLondonNO2(`Dist. from C. London NO2 Coef.`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopDistCLondonNO2,
              group = "Dist. from C. London NO2 Coef."
              ) %>% 
  addPolygons(data = SFMSOA, 
              fillColor = ~PalDistCLondonPM2.5(`Dist. from C. London PM2.5 Coef.`),
              color = "black",
              stroke = "black", 
              weight = 0.1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "white", weight = 1, bringToFront = TRUE),
              popup = PopDistCLondonPM2.5,
              group = "Dist. from C. London PM2.5 Coef."
              ) %>% 

  
  
  
  
# Layer Controls
  addLayersControl(
    baseGroups = c("OSM (default)", "Toner", "CartoDB"),
    overlayGroups = c("LAD", "MSOA", "LSOA", "Mean NO2 Conc.", "Mean PM2.5 Conc.", "NO2 Getis Ord G", "PM2.5 Getis Ord G", "Schools (All)", "GPs (All)", "Hospitals (All)", "Schools (NO2)", "GPs (NO2)", "Hospitals (NO2)", "Schools (PM2.5)", "GPs (PM2.5)", "Hospitals (PM2.5)", "Schools (All) Moran's I", "GPs (All) Moran's I", "Hospitals (All) Moran's I", "Schools (NO2) Moran's I", "GPs (NO2) Moran's I", "Hospitals (NO2) Moran's I", "Schools (PM2.5) Moran's I", "GPs (PM2.5) Moran's I", "Hospitals (PM2.5) Moran's I", "IMD Score", "Road Density (km/km2)", "Dist. from C. London (km)", "IMD NO2 Coef.", "IMD PM2.5 Coef.", "Road Density NO2 Coef.", "Road Density PM2.5 Coef.", "Dist. from C. London NO2 Coef.", "Dist. from C. London PM2.5 Coef."),
    position = "topright",
    options = layersControlOptions(collapsed = TRUE)
    ) %>% 

  
  
  
  
# Legends
  addLegend(pal = PalNO2, values = SFMSOA$`Mean NO2 Conc.`, title = "Mean NO2 Conc.", group = "Mean NO2 Conc.") %>%
  addLegend(pal = PalPM2.5, values = SFMSOA$`Mean PM2.5 Conc.`, title = "Mean PM2.5 Conc.", group = "Mean PM2.5 Conc.") %>%
  addLegend(pal = PalNO2Cluster, values = SFAreaCluster$`NO2 Getis Ord G`, title = "NO2 Getis Ord G", group = "NO2 Getis Ord G") %>%
  addLegend(pal = PalPM2.5Cluster, values = SFAreaCluster$`PM2.5 Getis Ord G`, title = "PM2.5 Getis Ord G", group = "PM2.5 Getis Ord G") %>%
  addLegend(pal = PalAll, values = SFLocations$`Building Type`, title = "All Buildings") %>% 
  addLegend(pal = PalWHO, values = SFLocationsNO2$`Building Type`, title = "Exceeding Limits") %>% 
  addLegend(pal = PalSchoolsCluster, values = SFPointCluster$`School (All) Moran's I`, title = "Schools (All) Moran's I", group = "Schools (All) Moran's I") %>%
  addLegend(pal = PalGPsCluster, values = SFPointCluster$`GP (All) Moran's I`, title = "GPs (All) Moran's I", group = "GPs (All) Moran's I") %>%
  addLegend(pal = PalHospitalsCluster, values = SFPointCluster$`Hospital (All) Moran's I`, title = "Hospitals (All) Moran's I", group = "Hospitals (All) Moran's I") %>%
  addLegend(pal = PalSchoolsNO2Cluster, values = SFPointCluster$`School (NO2) Moran's I`, title = "Schools (NO2) Moran's I", group = "Schools (NO2) Moran's I") %>%
  addLegend(pal = PalGPsNO2Cluster, values = SFPointCluster$`GP (NO2) Moran's I`, title = "GPs (NO2) Moran's I", group = "GPs (NO2) Moran's I") %>%
  addLegend(pal = PalHospitalsNO2Cluster, values = SFPointCluster$`Hospital (NO2) Moran's I`, title = "Hospitals (NO2) Moran's I", group = "Hospitals (NO2) Moran's I") %>%
  addLegend(pal = PalSchoolsPM2.5Cluster, values = SFPointCluster$`School (PM2.5) Moran's I`, title = "Schools (PM2.5) Moran's I", group = "Schools (PM2.5) Moran's I") %>%
  addLegend(pal = PalGPsPM2.5Cluster, values = SFPointCluster$`GP (PM2.5) Moran's I`, title = "GPs (PM2.5) Moran's I", group = "GPs (PM2.5) Moran's I") %>%
  addLegend(pal = PalHospitalsPM2.5Cluster, values = SFPointCluster$`Hospital (PM2.5) Moran's I`, title = "Hospitals (PM2.5) Moran's I", group = "Hospitals (PM2.5) Moran's I") %>%
  addLegend(pal = PalIMDScore, values = SFMSOA$`IMD Score`, title = "IMD Score", group = "IMD Score") %>%
  addLegend(pal = PalRoadDensity, values = SFMSOA$`Road Density (km/km2)`, title = "Road Density (km/km2)", group = "Road Density (km/km2)") %>%
  addLegend(pal = PalDistCLondon, values = SFMSOA$`Dist. from C. London (km)`, title = "Dist. from C. London (km)", group = "Dist. from C. London (km)") %>%
  addLegend(pal = PalIMDScoreNO2, values = SFMSOA$`IMD NO2 Coef.`, title = "IMD NO2 Coef.", group = "IMD NO2 Coef.") %>%
  addLegend(pal = PalIMDScorePM2.5, values = SFMSOA$`IMD PM2.5 Coef.`, title = "IMD PM2.5 Coef.", group = "IMD PM2.5 Coef.") %>%
  addLegend(pal = PalRoadDensityNO2, values = SFMSOA$`Road Density NO2 Coef.`, title = "Road Density NO2 Coef.", group = "Road Density NO2 Coef.") %>%
  addLegend(pal = PalRoadDensityPM2.5, values = SFMSOA$`Road Density PM2.5 Coef.`, title = "Road Density PM2.5 Coef.", group = "Road Density PM2.5 Coef.") %>%
  addLegend(pal = PalDistCLondonNO2, values = SFMSOA$`Dist. from C. London NO2 Coef.`, title = "Dist. from C. London NO2 Coef.", group = "Dist. from C. London NO2 Coef.") %>%
  addLegend(pal = PalDistCLondonPM2.5, values = SFMSOA$`Dist. from C. London PM2.5 Coef.`, title = "Dist. from C. London PM2.5 Coef.", group = "Dist. from C. London PM2.5 Coef.") %>%

  
  
# Groups, Buttons, etc.
  hideGroup(c("LSOA", "Mean NO2 Conc.", "Mean PM2.5 Conc.", "NO2 Getis Ord G", "PM2.5 Getis Ord G", "Schools (NO2)", "GPs (NO2)", "Hospitals (NO2)", "Schools (PM2.5)", "GPs (PM2.5)", "Hospitals (PM2.5)", "Schools (All) Moran's I", "GPs (All) Moran's I", "Hospitals (All) Moran's I", "Schools (NO2) Moran's I", "GPs (NO2) Moran's I", "Hospitals (NO2) Moran's I", "Schools (PM2.5) Moran's I", "GPs (PM2.5) Moran's I", "Hospitals (PM2.5) Moran's I", "IMD Score", "Road Density (km/km2)", "Dist. from C. London (km)", "IMD NO2 Coef.", "IMD PM2.5 Coef.", "Road Density NO2 Coef.", "Road Density PM2.5 Coef.", "Dist. from C. London NO2 Coef.", "Dist. from C. London PM2.5 Coef.")) %>% 
  addEasyButton(easyButton(
    icon="fa-globe", title="Zoom to London",
    onClick=JS("function(btn, map){ map.setView([51.5, -0.10],10); }"))) %>% 
  addScaleBar(position = "bottomleft", 
              options = scaleBarOptions(metric = TRUE))
  
MapLeaflet
```
