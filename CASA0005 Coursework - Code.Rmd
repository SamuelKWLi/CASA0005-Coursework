---
title: "CASA0005 Coursework - Code"
output: html_document
editor_options: 
  chunk_output_type: console
---
### Packages
```{r}
library(tidyverse)
library(raster)
library(rgdal)
library(sf)
library(tmap)
library(leafpop)
library(leaflet)
library(htmltools)
library(GISTools)
library(RColorBrewer)
library(BAMMtools)
library(spdep)
library(broom)
library(corrplot)
library(car)
library(spgwr)

# Set tmap to view mode
tmap_mode("view")
```

### Read in Concentration Rasters
```{r}
# List the full file paths of all the raster files.
PollutionFiles <- list.files("Data/Air Pollution/LAEI 2016 Concentrations", ".tif", full.names = TRUE)

# Stack the raster files into a single stack.
PollutionConc <- stack(PollutionFiles)

# List the raster names.
PollutionNames <- c("NO2", "PM2.5")

# Rename the raster files.
names(PollutionConc) <- PollutionNames

# Set BNG coordinate system.
BNG = "+init=epsg:27700"

# Set WGS84 coordinate system.
WGS84 = "+init=epsg:4326"

# Reproject raster stack into BNG.
PollutionConc <- projectRaster(PollutionConc, crs= WGS84)

```

### Crop Raster Data
```{r}
# Read in the London boundary.
OutlineLondon <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/London_Boundary.shp")

# Transform CRS into WGS84.
OutlineLondon <- st_transform(OutlineLondon, WGS84)

# Set extent to the London area.
ExtentLondon <- extent(OutlineLondon)

# Crop the rasters to the London outline.
CropNO2 <- crop(PollutionConc[[1]], OutlineLondon)
CropPM2.5 <- crop(PollutionConc[[2]], OutlineLondon)

# Mask rasters to the London outline.
MaskNO2 <-  mask(PollutionConc[[1]], OutlineLondon, na.rm=TRUE)
MaskPM2.5 <-  mask(PollutionConc[[2]], OutlineLondon, na.rm=TRUE)

# Stack the masked rasters.
PollutionLondon <- stack(MaskNO2, MaskPM2.5)
```

### Read in Boundaries
```{r}
# Read in boundaries as spatial polygons.
LAD <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/London_Borough_Excluding_MHW.shp")
MSOA <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/MSOA_2011_London_gen_MHW.shp")
LSOA <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/LSOA_2011_London_gen_MHW.shp")

# Convert from an sp object to sf object.
SFLAD <- st_as_sf(LAD)
SFMSOA <- st_as_sf(MSOA)
SFLSOA <- st_as_sf(LSOA)

# Transform CRS to WGS84.
SFLAD <- st_transform(SFLAD, WGS84)
SFMSOA <- st_transform(SFMSOA, WGS84)
SFLSOA <- st_transform(SFLSOA, WGS84)

# Select relevent columns.
SFLAD <- SFLAD[,c(1, 2, 8)]
SFMSOA <- SFMSOA[,c(2, 1, 4, 3, 13)]
SFLSOA <- SFLSOA[,c(2, 1, 4, 3, 6, 5, 15)]

# Rename columns.
colnames(SFLAD) <- c("LAD Name", "LAD Code", "geometry")
colnames(SFMSOA) <- c("MSOA Name", "MSOA Code", "LAD Name", "LAD Code", "geometry")
colnames(SFLSOA) <- c("LSOA Name", "LSOA Code", "MSOA Name", "MSOA Code","LAD Name", "LAD Code", "geometry")

```

### Read in School, GP and Hospital Data
```{r}
# Read in code points.
AllCodePoints <- read_csv("Data/Schools and Health/OS Point Codes/Data/AllCodePoints.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")

# Read in  data.
Schools <- read_csv("Data/Schools and Health/All School Locations 2016.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
GPs <- read_csv("Data/Schools and Health/GP Locations.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
Hospitals <- read_csv("Data/Schools and Health/Hospital Locations.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
# Select the necessary columns.
Schools <- Schools[,c(3, 8)]
GPs <- GPs[,c(1, 9)]
Hospitals <- Hospitals[,c(1, 9)]

# Rename Columns.
colnames(Schools) <- c("Name", "Postcode")
colnames(GPs) <- c("Name", "Postcode")
colnames(Hospitals) <- c("Name", "Postcode")

# Classify data.
Schools$Type <- "School"
GPs$Type <- "GP"
Hospitals$Type <- "Hospital"

# Merge school, GP and hospital points.
Locations <- rbind(Schools, GPs, Hospitals)

# Remove space in postcodes
Locations$Postcode <- gsub(" ","", Locations$Postcode)

# Attach code points.
Locations<-merge(Locations, 
             AllCodePoints, 
             by.x="Postcode", 
             by.y="Postcode",
             no.dups = TRUE)

# Reorder columns
Locations <- Locations[,c(2, 1, 3, 4, 5)]

# Remove duplicates.
Locations <- Locations[!duplicated(Locations$Name), ]

```

### Extract Concentrations for Schools, GPs and Hospitals
```{r}
# Convert location coordinates into point geometry.
SFLocations <- st_as_sf(Locations, coords = c("Eastings", "Northings"), crs = BNG)

# Transform CRS into WGS84.
SFLocations <- st_transform(SFLocations, WGS84)

# Select points inside London.
SFLocations <- SFLocations[SFLAD,]

# Extract concentrations.
SFLocations$`NO2 (µg/m³)`<- raster::extract(PollutionConc[[1]], SFLocations)
SFLocations$`PM2.5 (µg/m³)`<- raster::extract(PollutionConc[[2]], SFLocations)

# Round concentrations to 2 d.p..
SFLocations$`NO2 (µg/m³)` <- round(SFLocations$`NO2 (µg/m³)`, digits = 2)
SFLocations$`PM2.5 (µg/m³)` <- round(SFLocations$`PM2.5 (µg/m³)`, digits = 2)

# Rename columns.
colnames(SFLocations) <- c("Building Name", "Postcode", "Building Type", "geometry", "NO2 (µg/m³)", "PM2.5 (µg/m³)")

# Extract schools, GPs and hospitals that exceed WHO guides
SFLocationsNO2 <- SFLocations %>% filter(`NO2 (µg/m³)` > 40)
SFLocationsPM2.5 <- SFLocations %>% filter(`PM2.5 (µg/m³)` > 10)

```

### Subset Location Data
```{r}
SFSchools <- subset(SFLocations, `Building Type` == "School")

SFGPs <- subset(SFLocations, `Building Type` == "GP")

SFHospitals <- subset(SFLocations, `Building Type` == "Hospital")

SFSchoolsNO2 <- subset(SFLocationsNO2, `Building Type` == "School")

SFGPsNO2 <- subset(SFLocationsNO2, `Building Type` == "GP")

SFHospitalsNO2 <- subset(SFLocationsNO2, `Building Type` == "Hospital")

SFSchoolsPM2.5 <- subset(SFLocationsPM2.5, `Building Type` == "School")

SFGPsPM2.5 <- subset(SFLocationsPM2.5, `Building Type` == "GP")

SFHospitalsPM2.5 <- subset(SFLocationsPM2.5, `Building Type` == "Hospital")

```

### MSOA Cluster Data for Points
```{r}
# Convert SF objects into SP objects
SPClusterMSOA <- as(SFMSOA, "Spatial")
SPSchools <- as(SFSchools, "Spatial")
SPGPs <- as(SFGPs, "Spatial")
SPHospitals <- as(SFHospitals, "Spatial")
SPSchoolsNO2 <- as(SFSchoolsNO2, "Spatial")
SPGPsNO2 <- as(SFGPsNO2, "Spatial")
SPHospitalsNO2 <- as(SFHospitalsNO2, "Spatial")
SPSchoolsPM2.5 <- as(SFSchoolsPM2.5, "Spatial")
SPGPsPM2.5 <- as(SFGPsPM2.5, "Spatial")
SPHospitalsPM2.5 <- as(SFHospitalsPM2.5, "Spatial")

# Transform CRS to BNG (a projected CRS).
SPClusterMSOA <- spTransform(SPClusterMSOA, BNG)
SPSchools <- spTransform(SPSchools, BNG)
SPGPs <- spTransform(SPGPs, BNG)
SPHospitals <- spTransform(SPHospitals, BNG)
SPSchoolsNO2 <- spTransform(SPSchoolsNO2, BNG)
SPGPsNO2 <- spTransform(SPGPsNO2, BNG)
SPHospitalsNO2 <- spTransform(SPHospitalsNO2, BNG)
SPSchoolsPM2.5 <- spTransform(SPSchoolsPM2.5, BNG)
SPGPsPM2.5 <- spTransform(SPGPsPM2.5, BNG)
SPHospitalsPM2.5 <- spTransform(SPHospitalsPM2.5, BNG)

# Count the number of points in each MSOA.
SPClusterMSOA@data$SchoolCount <- poly.counts(SPSchools, SPClusterMSOA)
SPClusterMSOA@data$GPCount <- poly.counts(SPGPs, SPClusterMSOA)
SPClusterMSOA@data$HospitalCount <- poly.counts(SPHospitals, SPClusterMSOA)
SPClusterMSOA@data$SchoolNO2Count <- poly.counts(SPSchoolsNO2, SPClusterMSOA)
SPClusterMSOA@data$GPNO2Count <- poly.counts(SPGPsNO2, SPClusterMSOA)
SPClusterMSOA@data$HospitalNO2Count <- poly.counts(SPHospitalsNO2, SPClusterMSOA)
SPClusterMSOA@data$SchoolPM2.5Count <- poly.counts(SPSchoolsPM2.5, SPClusterMSOA)
SPClusterMSOA@data$GPPM2.5Count <- poly.counts(SPGPsPM2.5, SPClusterMSOA)
SPClusterMSOA@data$HospitalPM2.5Count <- poly.counts(SPHospitalsPM2.5, SPClusterMSOA)

# Calculate point density.
SPClusterMSOA@data$SchoolDensity <- round(SPClusterMSOA@data$SchoolCount/(poly.areas(SPClusterMSOA)/1000000), digits = 3)
SPClusterMSOA@data$GPDensity <- round(SPClusterMSOA@data$GPCount/(poly.areas(SPClusterMSOA)/1000000), digits = 3)
SPClusterMSOA@data$HospitalDensity <- round(SPClusterMSOA@data$HospitalCount/(poly.areas(SPClusterMSOA)/1000000), digits = 3)
SPClusterMSOA@data$SchoolNO2Density <- round(SPClusterMSOA@data$SchoolNO2Count/(poly.areas(SPClusterMSOA)/1000000), digits = 3)
SPClusterMSOA@data$GPNO2Density <- round(SPClusterMSOA@data$GPNO2Count/(poly.areas(SPClusterMSOA)/1000000), digits = 3)
SPClusterMSOA@data$HospitalNO2Density <- round(SPClusterMSOA@data$HospitalNO2Count/ (poly.areas(SPClusterMSOA)/1000000), digits = 3)
SPClusterMSOA@data$SchoolPM2.5Density <- round(SPClusterMSOA@data$SchoolPM2.5Count/ (poly.areas(SPClusterMSOA)/1000000), digits = 3)
SPClusterMSOA@data$GPPM2.5Density <- round(SPClusterMSOA@data$GPPM2.5Count/ (poly.areas(SPClusterMSOA)/1000000), digits = 3)
SPClusterMSOA@data$HospitalPM2.5Density <- round(SPClusterMSOA@data$HospitalPM2.5Count / (poly.areas(SPClusterMSOA)/1000000), digits = 3)

# Determine centroids for MSOAs
CentroidMSOA <- coordinates(SPClusterMSOA)
plot(CentroidMSOA)

# Create neighbour list using queen's case neighbours.
NNListMSOA <- poly2nb(SFMSOA, queen=T)
plot(NNListMSOA, coordinates(CentroidMSOA), col="red")

# Create spatial weights object.
SpWeightsMSOA <- nb2listw(NNListMSOA, style="C")

# Conduct global Moran's I.
GlbMIAllSchool <- moran.test(SPClusterMSOA@data$SchoolDensity, SpWeightsMSOA)
GlbMIAllGP <- moran.test(SPClusterMSOA@data$GPDensity, SpWeightsMSOA)
GlbMIAllHospital <- moran.test(SPClusterMSOA@data$HospitalDensity, SpWeightsMSOA)
GlbMINO2School <- moran.test(SPClusterMSOA@data$SchoolNO2Density, SpWeightsMSOA)
GlbMINO2GP <- moran.test(SPClusterMSOA@data$GPNO2Density, SpWeightsMSOA)
GlbMINO2Hospital <- moran.test(SPClusterMSOA@data$HospitalNO2Density, SpWeightsMSOA)
GlbMIPM2.5School <- moran.test(SPClusterMSOA@data$SchoolPM2.5Density, SpWeightsMSOA)
GlbMIPM2.5GP <- moran.test(SPClusterMSOA@data$GPPM2.5Density, SpWeightsMSOA)
GlbMIPM2.5Hospital <- moran.test(SPClusterMSOA@data$HospitalPM2.5Density, SpWeightsMSOA)

# Conduct local Moran's I.
lclMIAllSchool <- round(localmoran(SPClusterMSOA@data$SchoolDensity, SpWeightsMSOA), digits = 3)
lclMIAllGP <- round(localmoran(SPClusterMSOA@data$GPDensity, SpWeightsMSOA), digits = 3)
lclMIAllHospital <- round(localmoran(SPClusterMSOA@data$HospitalDensity, SpWeightsMSOA), digits = 3)
lclMINO2School <- round(localmoran(SPClusterMSOA@data$SchoolNO2Density, SpWeightsMSOA), digits = 3)
lclMINO2GP <- round(localmoran(SPClusterMSOA@data$GPNO2Density, SpWeightsMSOA), digits = 3)
lclMINO2Hospital <- round(localmoran(SPClusterMSOA@data$HospitalNO2Density, SpWeightsMSOA), digits = 3)
lclMIPM2.5School <- round(localmoran(SPClusterMSOA@data$SchoolPM2.5Density, SpWeightsMSOA), digits = 3)
lclMIPM2.5GP <- round(localmoran(SPClusterMSOA@data$GPPM2.5Density, SpWeightsMSOA), digits = 3)
lclMIPM2.5Hospital <- round(localmoran(SPClusterMSOA@data$HospitalPM2.5Density, SpWeightsMSOA), digits = 3)

# Join local Moran's I Z values to shape file.
SPClusterMSOA$lclMIAllSchool <- lclMIAllSchool[,4]
SPClusterMSOA$lclMIAllGP <- lclMIAllGP[,4]
SPClusterMSOA$lclMIAllHospital <- lclMIAllHospital[,4]
SPClusterMSOA$lclMINO2School <- lclMINO2School[,4]
SPClusterMSOA$lclMINO2GP <- lclMINO2GP[,4]
SPClusterMSOA$lclMINO2Hospital <- lclMINO2Hospital[,4]
SPClusterMSOA$lclMIPM2.5School <- lclMIPM2.5School[,4]
SPClusterMSOA$lclMIPM2.5GP <- lclMIPM2.5GP[,4]
SPClusterMSOA$lclMIPM2.5Hospital <- lclMIPM2.5Hospital[,4]

# Convert SP MSOA data into a data frame.
SFClusterMSOA <- st_as_sf(SPClusterMSOA)

# Transform CRS to WGS
SFClusterMSOA <- st_transform(SFClusterMSOA, WGS84)

# Rename columns.
colnames(SFClusterMSOA) <- c("MSOA Name", "MSOA Code", "LAD Name", "LAD Code", "School (All) Count", "GP (All) Count", "Hospital (All) Count", "School (NO2) Count", "GP (NO2) Count", "Hospital (NO2) Count", "School (PM2.5) Count", "GP (PM2.5) Count", "Hospital (PM2.5) Count", "School (All) Density", "GP (All) Density", "Hospital (All) Density", "School (NO2) Density", "GP (NO2) Density", "Hospital (NO2) Density", "School (PM2.5) Density", "GP (PM2.5) Density", "Hospital (PM2.5) Density", "School (All) Moran's I", "GP (All) Moran's I", "Hospital (All) Moran's I", "School (NO2) Moran's I", "GP (NO2) Moran's I", "Hospital (NO2) Moran's I", "School (PM2.5) Moran's I", "GP (PM2.5) Moran's I", "Hospital (PM2.5) Moran's I", "geometry")

# Moran's I breaks.
BrksMi <-c(-1000,-2.58,-1.96,-1.65,1.65,1.96,2.58,1000)

# Moran's I palette.
PalMi<- rev(brewer.pal(7, "RdBu"))

# Map Moran's I.
tm_shape(SFClusterMSOA) +
  tm_polygons(col = "School (All) Moran's I", palette = PalMi, breaks = BrksMi)
tm_shape(SFClusterMSOA) +
  tm_polygons(col = "GP (All) Moran's I", palette = PalMi, breaks = BrksMi)
tm_shape(SFClusterMSOA) +
  tm_polygons(col = "Hospital (All) Moran's I", palette = PalMi, breaks = BrksMi)
tm_shape(SFClusterMSOA) +
  tm_polygons(col = "School (NO2) Moran's I", palette = PalMi, breaks = BrksMi)
tm_shape(SFClusterMSOA) +
  tm_polygons(col = "GP (NO2) Moran's I", palette = PalMi, breaks = BrksMi)
tm_shape(SFClusterMSOA) +
  tm_polygons(col = "Hospital (NO2) Moran's I", palette = PalMi, breaks = BrksMi)
tm_shape(SFClusterMSOA) +
  tm_polygons(col = "School (PM2.5) Moran's I", palette = PalMi, breaks = BrksMi)
tm_shape(SFClusterMSOA) +
  tm_polygons(col = "GP (PM2.5) Moran's I", palette = PalMi, breaks = BrksMi)
tm_shape(SFClusterMSOA) +
  tm_polygons(col = "Hospital (PM2.5) Moran's I", palette = PalMi, breaks = BrksMi)
```

### Index of Multiple Deprivation 
```{r}
# Read in indices of deprivation data.
IDData <- read_csv("Data/Boundaries and Census/ID 2019 for London.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
# Merge ID data to location data.
IDData<-merge(IDData, 
             SFLSOA, 
             by.x="LSOA code (2011)", 
             by.y="LSOA Code",
             no.dups = TRUE,
             all.x = TRUE)

# Extract relevent columns.
IDData <- IDData[,c(1, 31, 33, 5, 8, 11, 14, 17, 20, 23, 26)]

# Rename columns.
colnames(IDData) <- c("LSOA Code", "MSOA Code", "LAD Code", "IMD Score", "Income Score", "Employment Score", "Education Score", "Health Score", "Crime Score", "Housing Score", "Environment Score")

# Aggregate IDM scores to MSOA and LADs.
IDLSOA <- IDData[,c(1, 4:11)]
IDMSOA <- aggregate(IDData[,c(4:11)], by = list(IDData$`MSOA Code`), FUN = mean)
IDLAD <- aggregate(IDData[,c(4:11)], by = list(IDData$`LAD Code`), FUN = mean)
IDMSOA[,c(2:9)] <- round(IDMSOA[,c(2:9)], digits = 3)
IDLAD[,c(2:9)] <- round(IDLAD[,c(2:9)], digits = 3)
colnames(IDMSOA) <- c("MSOA Code", "IMD Score", "Income Score", "Employment Score", "Education Score", "Health Score", "Crime Score", "Housing Score", "Environment Score")
colnames(IDLAD) <- c("LAD Code", "IMD Score", "Income Score", "Employment Score", "Education Score", "Health Score", "Crime Score", "Housing Score", "Environment Score")

# Merge ID data to boundaries.
SFLAD<-merge(SFLAD, 
             IDLAD, 
             by.x="LAD Code", 
             by.y="LAD Code",
             no.dups = TRUE,
             all.x = TRUE)
SFMSOA<-merge(SFMSOA, 
             IDMSOA, 
             by.x="MSOA Code", 
             by.y="MSOA Code",
             no.dups = TRUE,
             all.x = TRUE)
SFLSOA<-merge(SFLSOA, 
             IDLSOA, 
             by.x="LSOA Code", 
             by.y="LSOA Code",
             no.dups = TRUE,
             all.x = TRUE)
```

### NO2 and PM2.5. Mean Concentration
```{r}
# Read in Concentration data.
ConcLAD <- read_csv("Data/Air Pollution/ConcLAD.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
ConcMSOA <- read_csv("Data/Air Pollution/ConcMSOA.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
ConcLSOA <- read_csv("Data/Air Pollution/ConcLSOA.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")

# Extract relevent columns.
ConcLAD <- ConcLAD[,c(2:4)]
ConcMSOA <- ConcMSOA[,c(2, 5, 6)]
ConcLSOA <- ConcLSOA[,c(2, 7, 8)]

# Round concentration
ConcLAD[, c(2, 3)] <- round(ConcLAD[, c(2, 3)], digits = 3)
ConcMSOA[, c(2, 3)] <- round(ConcMSOA[, c(2, 3)], digits = 3)
ConcLSOA[, c(2, 3)] <- round(ConcLSOA[, c(2, 3)], digits = 3)

# Merge ID data to boundaries.
SFLAD<-merge(SFLAD, 
             ConcLAD, 
             by.x="LAD Code", 
             by.y="LAD Code",
             no.dups = TRUE,
             all.x = TRUE)
SFMSOA<-merge(SFMSOA, 
             ConcMSOA, 
             by.x="MSOA Code", 
             by.y="MSOA Code",
             no.dups = TRUE,
             all.x = TRUE)
SFLSOA<-merge(SFLSOA, 
             ConcLSOA, 
             by.x="LSOA Code", 
             by.y="LSOA Code",
             no.dups = TRUE,
             all.x = TRUE)
```

### Linear Regression Model
```{r}
# Conduct linear regression.
LRNO2 <- lm(`Mean NO2 Conc.` ~ `IMD Score` + `Income Score` + `Employment Score` + `Education Score` + `Health Score` + `Crime Score` + `Housing Score` + `Environment Score`, data = SFMSOA)
LRPM2.5 <- lm(`Mean PM2.5 Conc.` ~ `IMD Score` + `Income Score` + `Employment Score` + `Education Score` + `Health Score` + `Crime Score` + `Housing Score` + `Environment Score`, data = SFMSOA)

# Summarise data.
summary(LRNO2)
summary(LRPM2.5)

# Extract linear regression results.
LRResultsNO2 <- tidy(LRNO2)
LRResultsPM2.5 <- tidy(LRPM2.5)

```

### Linear Regression - Assumption 1
```{r}
# Plot histogram on variables.
ggplot(SFMSOA, aes(x=`Mean NO2 Conc.`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 1) + 
  geom_density(colour="red", size=1, adjust=1)
ggplot(SFMSOA, aes(x=`Mean PM2.5 Conc.`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 0.1) + 
  geom_density(colour="red", size=1, adjust=1)
ggplot(SFMSOA, aes(x=`IMD Score`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 1) + 
  geom_density(colour="red", size=1, adjust=1)
ggplot(SFMSOA, aes(x=`Income Score`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 0.01) + 
  geom_density(colour="red", size=1, adjust=1)
ggplot(SFMSOA, aes(x=`Employment Score`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 0.01) + 
  geom_density(colour="red", size=1, adjust=1)
ggplot(SFMSOA, aes(x=`Health Score`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 0.1) + 
  geom_density(colour="red", size=1, adjust=1)
ggplot(SFMSOA, aes(x=`Crime Score`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 0.1) + 
  geom_density(colour="red", size=1, adjust=1)
ggplot(SFMSOA, aes(x=`Housing Score`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 1) + 
  geom_density(colour="red", size=1, adjust=1)
ggplot(SFMSOA, aes(x=`Environment Score`)) + 
  geom_histogram(aes(y = ..density..),binwidth = 1) + 
  geom_density(colour="red", size=1, adjust=1)

# Plot Scatter plot
qplot(x = `Mean NO2 Conc.`, y = `IMD Score`, data = SFMSOA)
```

### Linear Regression - Assumption 2
```{r}
# Plot linear regression model residuals in a histogram.
qplot(LRNO2$residuals) + geom_histogram() 
qplot(LRPM2.5$residuals) + geom_histogram() 
```

### Linear Regression - Assumption 3
```{r}
# Remove geometry of SFMSOA.
CorMSOA <- st_set_geometry(SFMSOA,NULL)

# Extract dependent varaiables
CorMSOA <- CorMSOA[,c(5:12)]

# Calculate correlation matrix.
CorMSOA <- cor(CorMSOA, use="complete.obs", method="pearson")

# Plot correlation matrix.
corrplot(CorMSOA, type = "lower")

# Calculate VIF.
vif(LRNO2)
vif(LRPM2.5)
```

### Linear Regression - Assumption 4
```{r}
# Plot model diagnostics.
plot(LRNO2)
plot(LRPM2.5)

```

### Linear Regression - Assumption 5
```{r}
# Merge model residuals to shapefile.
SFMSOA$`LRNO2 Residuals` <- LRNO2$residuals
SFMSOA$`LRPM2.5 Residuals` <- LRPM2.5$residuals

# Map model residuals.
tm_shape(SFMSOA) +
  tm_polygons("LRNO2 Residuals",
              palette = "RdYlBu")
tm_shape(SFMSOA) +
  tm_polygons("LRPM2.5 Residuals",
              palette = "RdYlBu")

# Convert SF objects to SP objects.
SPMSOA <- as(SFMSOA, "Spatial")

# Run Moran's I on residuals.
moran.test(SPMSOA@data$LRNO2.Residuals, SpWeightsMSOA)
moran.test(SPMSOA@data$LRPM2.5.Residuals, SpWeightsMSOA)

```

### GWR
```{r}
# Calculate kernel bandwidths.
GWRbandwidthNO2 <- gwr.sel(`Mean NO2 Conc.` ~ `IMD Score` + `Income Score` + `Employment Score` + `Education Score` + `Health Score` + `Crime Score` + `Housing Score` + `Environment Score`, data = SFMSOA, coords=CentroidMSOA, adapt=T)
GWRbandwidthPM2.5 <- gwr.sel(`Mean PM2.5 Conc.` ~ `IMD Score` + `Income Score` + `Employment Score` + `Education Score` + `Health Score` + `Crime Score` + `Housing Score` + `Environment Score`, data = SFMSOA, coords=CentroidMSOA, adapt=T)

# Run the GWR model.
GWRNO2 = gwr(`Mean NO2 Conc.` ~ `IMD Score` + `Income Score` + `Employment Score` + `Education Score` + `Health Score` + `Crime Score` + `Housing Score` + `Environment Score`, data = SFMSOA, coords=CentroidMSOA, adapt=GWRbandwidthNO2, hatmatrix=TRUE, se.fit=TRUE)
GWRPM2.5 = gwr(`Mean PM2.5 Conc.` ~ `IMD Score` + `Income Score` + `Employment Score` + `Education Score` + `Health Score` + `Crime Score` + `Housing Score` + `Environment Score`, data = SFMSOA, coords=CentroidMSOA, adapt=GWRbandwidthNO2, hatmatrix=TRUE, se.fit=TRUE)

# Save the results.
GWRNO2Results <- as.data.frame(GWRNO2$SDF)
GWRPM2.5Results <- as.data.frame(GWRPM2.5$SDF)

# Merge coefficients with shapefiles.
SFMSOA$`IMD NO2 Coef.`<- round(GWRNO2Results$X.IMD.Score., digits = 3)
SFMSOA$`Income NO2 Coef.`<- round(GWRNO2Results$X.Income.Score., digits = 3)
SFMSOA$`Employment NO2 Coef.`<- round(GWRNO2Results$X.Employment.Score., digits = 3)
SFMSOA$`Education NO2 Coef.`<- round(GWRNO2Results$X.Education.Score., digits = 3)
SFMSOA$`Health NO2 Coef.`<- round(GWRNO2Results$X.Health.Score., digits = 3)
SFMSOA$`Crime NO2 Coef.`<- round(GWRNO2Results$X.Crime.Score., digits = 3)
SFMSOA$`Housing NO2 Coef.`<- round(GWRNO2Results$X.Housing.Score., digits = 3)
SFMSOA$`Environment NO2 Coef.`<- round(GWRNO2Results$X.Environment.Score., digits = 3)

SFMSOA$`IMD PM2.5 Coef.`<- round(GWRPM2.5Results$X.IMD.Score., digits = 3)
SFMSOA$`Income PM2.5 Coef.`<- round(GWRPM2.5Results$X.Income.Score., digits = 3)
SFMSOA$`Employment PM2.5 Coef.`<- round(GWRPM2.5Results$X.Employment.Score., digits = 3)
SFMSOA$`Education PM2.5 Coef.`<- round(GWRPM2.5Results$X.Education.Score., digits = 3)
SFMSOA$`Health PM2.5 Coef.`<- round(GWRPM2.5Results$X.Health.Score., digits = 3)
SFMSOA$`Crime PM2.5 Coef.`<- round(GWRPM2.5Results$X.Crime.Score., digits = 3)
SFMSOA$`Housing PM2.5 Coef.`<- round(GWRPM2.5Results$X.Housing.Score., digits = 3)
SFMSOA$`Environment PM2.5 Coef.`<- round(GWRPM2.5Results$X.Environment.Score., digits = 3)

# Map coefficients.
tm_shape(SFMSOA) +
  tm_polygons(col = "IMD NO2 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "Income NO2 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "Employment NO2 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "Education NO2 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "Health NO2 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "Crime NO2 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "Housing NO2 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "Environment NO2 Coef.", palette = "RdBu", alpha = 1.0)

tm_shape(SFMSOA) +
  tm_polygons(col = "IMD PM2.5 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "Income PM2.5 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "Employment PM2.5 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "Education PM2.5 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "Health PM2.5 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "Crime PM2.5 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "Housing PM2.5 Coef.", palette = "RdBu", alpha = 1.0)
tm_shape(SFMSOA) +
  tm_polygons(col = "Environment PM2.5 Coef.", palette = "RdBu", alpha = 1.0)
```

