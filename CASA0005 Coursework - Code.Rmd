---
title: "CASA0005 Coursework - Code"
output: html_document
editor_options: 
  chunk_output_type: console
---
### Packages
```{r}
library(tidyverse)
library(raster)
library(rgdal)
library(sf)
library(tmap)
library(leafpop)
library(leaflet)
library(htmltools)
```

### Read in Concentration Rasters
```{r}
# List the full file paths of all the raster files.
PollutionFiles <- list.files("Data/Air Pollution/LAEI 2016 Concentrations", ".tif", full.names = TRUE)

# Stack the raster files into a single stack.
PollutionConc <- stack(PollutionFiles)

# List the raster names.
PollutionNames <- c("NO2", "NOx", "PM10", "PM10d", "PM2.5")

# Rename the raster files.
names(PollutionConc) <- PollutionNames

# Set BNG coordinate system.
WGS84 = "+init=epsg:4326"

# Reproject raster stack into BNG.
PollutionConc <- projectRaster(PollutionConc, crs=WGS84)

```

### Crop Raster Data
```{r}
# Read in the London boundary.
LondonOutline <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/London_Boundary.shp")
plot(LondonOutline$geometry)
LondonOutline <- st_transform(LondonOutline, 4326)

# Set extent to the London area.
LondonExtent <- extent(LondonOutline)

# Crop the rasters to the London outline.
NO2Crop <- crop(PollutionConc[[1]], LondonOutline)
NOxCrop <- crop(PollutionConc[[2]], LondonOutline)
PM10Crop <- crop(PollutionConc[[3]], LondonOutline)
PM10dCrop <- crop(PollutionConc[[4]], LondonOutline)
PM2.5Crop <- crop(PollutionConc[[5]], LondonOutline)

# Mask rasters to the London outline.
NO2Mask <-  mask(PollutionConc[[1]], LondonOutline, na.rm=TRUE)
NOxMask <-  mask(PollutionConc[[2]], LondonOutline, na.rm=TRUE)
PM10Mask <-  mask(PollutionConc[[3]], LondonOutline, na.rm=TRUE)
PM10dMask <-  mask(PollutionConc[[4]], LondonOutline, na.rm=TRUE)
PM2.5Mask <-  mask(PollutionConc[[5]], LondonOutline, na.rm=TRUE)

# Stack the masked rasters.
PollutionLon <- stack(NO2Mask, NOxMask, PM10Mask, PM10dMask, PM2.5Mask)
```

### Read in Borough and Ward Boundaries
```{r}
# Read in borough boundaries.
Boroughs <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/London_Borough_Excluding_MHW.shp")
Boroughs <- st_as_sf(Boroughs)
Boroughs <- st_transform(Boroughs, crs = 4326)
Boroughs <- Boroughs[,c(1, 2, 8)]
colnames(Boroughs) <- c("Borough Name", "Borough Code", "geometry")

# Read in ward boundaries.
Wards <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/London_Ward_CityMerged_Clip.shp")
Wards <- st_as_sf(Wards)
Wards <- st_transform(Wards, crs = 4326)
Wards <- Wards[,c(1, 2, 6, 5, 8)]
colnames(Wards) <- c("Ward Name", "Ward Code", "Borough Name", "Borough Code", "geometry")
```


### Read in Code Points
```{r}
# List full file paths for all of the code point csv files.
CodePointsFiles <- list.files(path = "Data/Schools and Health/OS Point Codes/Data", full.names=TRUE)

# Run a function for each code point file path, reading the csvs into an object.
AllCodePoints <- lapply(CodePointsFiles,function(i){
  read.csv(i, header=FALSE, skip=4)
})

# Convert the object into a data frame.
AllCodePoints <- do.call(rbind.data.frame, AllCodePoints)

# Rename the columns.
colnames(AllCodePoints) <- c("Postcode",	"Positional_quality_indicator",	"Eastings",	"Northings",	"Country_code",	"NHS_regional_HA_code",	"NHS_HA_code",	"Admin_county_code",	"Admin_district_code",	"Admin_ward_code")

# Specify relevent columns.
AllCodePoints <- AllCodePoints[,c(1, 3, 4)]

# Remove spaces in postcodes
AllCodePoints$Postcode <- gsub(" ","", AllCodePoints$Postcode)

# Write complete dataframe into a csv file.
write.csv(AllCodePoints,"AllCodePoints.csv", row.names=FALSE)

```

### Read in School, GP and Hospital Data
```{r}
# Read in  data.
Schools <- read_csv("Data/Schools and Health/All School Locations 2016.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
GPs <- read_csv("Data/Schools and Health/GP Locations.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
Hospitals <- read_csv("Data/Schools and Health/Hospital Locations.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
# Select the necessary columns.
Schools <- Schools[,c(3, 8)]
GPs <- GPs[,c(1, 9)]
Hospitals <- Hospitals[,c(1, 9)]

# Rename Columns.
colnames(Schools) <- c("Name", "Postcode")
colnames(GPs) <- c("Name", "Postcode")
colnames(Hospitals) <- c("Name", "Postcode")

# Classify data.
Schools$Type <- "School"
GPs$Type <- "GP"
Hospitals$Type <- "Hospital"

# Merge school, GP and hospital points.
Locations <- rbind(Schools, GPs, Hospitals)

# Remove space in postcodes
Locations$Postcode <- gsub(" ","", Locations$Postcode)

# Attach code points.
Locations<-merge(Locations, 
             AllCodePoints, 
             by.x="Postcode", 
             by.y="Postcode",
             no.dups = TRUE)

# Reorder columns
Locations <- Locations[,c(2, 1, 3, 4, 5)]

# Remove duplicates.
Locations <- Locations[!duplicated(Locations$Postcode), ]

```

### Extract Concentrations for Schools, GPs and Hospitals
```{r}
# Convert schools, GPs and hosptial coordinates into point geometry.
Locations <- st_as_sf(Locations, coords = c("Eastings", "Northings"), crs = 27700)
Locations <- st_transform(Locations, crs = 4326)

# Select points inside London.
Locations <- Locations[Boroughs,]

# Extract concentrations.
Locations$`NO2 (µg/m³)`<- raster::extract(PollutionConc[[1]], Locations)
Locations$`PM2.5 (µg/m³)`<- raster::extract(PollutionConc[[5]], Locations)

# Round concentrations to 2 d.p..
Locations$`NO2 (µg/m³)` <- round(Locations$`NO2 (µg/m³)`, digits = 2)
Locations$`PM2.5 (µg/m³)` <- round(Locations$`PM2.5 (µg/m³)`, digits = 2)

# Rename columns.
colnames(Locations) <- c("Building Name", "Postcode", "Building Type", "geometry", "NO2 (µg/m³)", "PM2.5 (µg/m³)")

# Extract schools, GPs and hospitals that exceed WHO guides
LocationsNO2 <- Locations %>% filter(`NO2 (µg/m³)` > 40)
LocationsPM2.5 <- Locations %>% filter(`PM2.5 (µg/m³)` > 10)

```

### Plot Map using tmap
```{r}
# Change tmap mode.
tmap_mode("view")

# Plot map of schools, GPs and hospitals.
Map <- tm_shape(Boroughs)+ 
  tm_fill(col = NA, alpha = 0)+ 
  tm_borders(col = "black")+
tm_shape(Wards)+ 
  tm_fill(col = NA, alpha = 0)+ 
  tm_borders(col = "black", alpha = 0.5)+
tm_shape(Locations)+
  tm_dots(title = "Building Type (All)", col = "Building Type", palette = c("lightblue", "navy", "lightgreen"))+
tm_shape(LocationsNO2)+
  tm_dots(title = "Building Type (NO2)", col = "Building Type", palette = c("red", "brown", "orange"))+
tm_shape(LocationsPM2.5)+
  tm_dots(title = "Building Type (PM2.5)", col = "Building Type", palette = c("red", "brown", "orange"))+
tm_layout(legend.show = TRUE)
Map

```
### Subset Location Data and Set Up Popups
```{r}
Schools <- subset(Locations, `Building Type` == "School")

GPs <- subset(Locations, `Building Type` == "GP")

Hospitals <- subset(Locations, `Building Type` == "Hospital")

SchoolsNO2 <- subset(LocationsNO2, `Building Type` == "School")

GPsNO2 <- subset(LocationsNO2, `Building Type` == "GP")

HospitalsNO2 <- subset(LocationsNO2, `Building Type` == "Hospital")

SchoolsPM2.5 <- subset(LocationsPM2.5, `Building Type` == "School")

GPsPM2.5 <- subset(LocationsPM2.5, `Building Type` == "GP")

HospitalsPM2.5 <- subset(LocationsPM2.5, `Building Type` == "Hospital")

```

### Popup Tables and Palettes
```{r}
# Create popup tables for boundaries
PopBoroughs <- Boroughs
st_geometry(PopBoroughs) <- NULL
PopBoroughs <- popupTable(PopBoroughs, feature.id = FALSE, row.numbers = FALSE, zcol=c("Borough Name", "Borough Code"))

PopWards <- Wards
st_geometry(PopWards) <- NULL
PopWards <- popupTable(PopWards, feature.id = FALSE, row.numbers = FALSE, zcol=c("Ward Name", "Ward Code", "Borough Name", "Borough Code"))

# Create popup tables for locations
PopSchools <- Schools
st_geometry(PopSchools) <- NULL
PopSchools <- popupTable(PopSchools, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))

PopGPs <- GPs
st_geometry(PopGPs) <- NULL
PopGPs <- popupTable(PopGPs, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))

PopHospitals <- Hospitals
st_geometry(PopHospitals) <- NULL
PopHospitals <- popupTable(PopHospitals, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))

# Create popup tables for locations exceeding NO2
PopSchoolsNO2 <- SchoolsNO2
st_geometry(PopSchoolsNO2) <- NULL
PopSchoolsNO2 <- popupTable(PopSchoolsNO2, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))

PopGPsNO2 <- GPsNO2
st_geometry(PopGPsNO2) <- NULL
PopGPs <- popupTable(PopGPsNO2, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))

PopHospitalsNO2 <- HospitalsNO2
st_geometry(PopHospitalsNO2) <- NULL
PopHospitalsNO2 <- popupTable(PopHospitalsNO2, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))

# Create popup tables for locations exceeding PM2.5
PopSchoolsPM2.5 <- SchoolsPM2.5
st_geometry(PopSchoolsPM2.5) <- NULL
PopSchoolsPM2.5 <- popupTable(PopSchoolsPM2.5, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))

PopGPsPM2.5 <- GPsPM2.5
st_geometry(PopGPsPM2.5) <- NULL
PopGPsPM2.5 <- popupTable(PopGPsPM2.5, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))

PopHospitalsPM2.5 <- HospitalsPM2.5
st_geometry(PopHospitalsPM2.5) <- NULL
PopHospitalsPM2.5 <- popupTable(PopHospitalsPM2.5, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))

# Create colour factors.
PalAll <- colorFactor(c("LightSkyBlue", "RoyalBlue", "LightGreen"), levels = c("GP", "Hospital", "School"))
PalWHO <- colorFactor(c("Orange", "Red", "Gold"), levels = c("GP", "Hospital", "School"))

```


### Plot Map using leaflet
```{r}
# Map using leaflet.
leaflet() %>% 
  addTiles(group = "OSM (default)") %>% 
  addPolygons(data = Boroughs, 
              fill = "transparent", 
              color = "black",
              stroke = "black",
              weight = 2, 
              opacity = 1.0, 
              fillOpacity = 0,
              highlightOptions = highlightOptions(color = "white", weight = 3,bringToFront = FALSE),
              label = PopBoroughs,
              group = "Boroughs"
              ) %>% 
  addPolygons(data = Wards, 
              fill = "transparent",
              color = "black",
              stroke = "black", 
              weight = 1, 
              opacity = 1.0, 
              fillOpacity = 0,
              highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = FALSE),
              popup = PopWards,
              group = "Wards"
              ) %>% 
  addCircleMarkers(data = Schools,
             color = ~PalAll(`Building Type`),
             radius = ~ifelse(`Building Type` == "Hospital", 10, 5),
             fillOpacity = 1.0,
             stroke = TRUE,
             opacity = 1.0,
             weight = 0.5,
             popup = PopSchools,
             group = "Schools (All)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'LightGreen'
                } else if (childCount < 100) {  
                  c = 'LightGreen'  
                } else { 
                  c = 'LightGreen'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = GPs,
             color = ~PalAll(`Building Type`),
             radius = ~ifelse(`Building Type` == "Hospital", 10, 5),
             fillOpacity = 1.0,
             stroke = TRUE,
             opacity = 1.0,
             weight = 0.5,
             popup = PopGPs,
             group = "GP (All)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'LightSkyBlue'
                } else if (childCount < 100) {  
                  c = 'LightSkyBlue'  
                } else { 
                  c = 'LightSkyBlue'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = Hospitals,
             color = ~PalAll(`Building Type`),
             radius = ~ifelse(`Building Type` == "Hospital", 10, 5),
             fillOpacity = 1.0,
             stroke = TRUE,
             opacity = 1.0,
             weight = 0.5,
             popup = PopHospitals,
             group = "Hospital (All)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'RoyalBlue'
                } else if (childCount < 100) {  
                  c = 'RoyalBlue'  
                } else { 
                  c = 'RoyalBlue'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = SchoolsNO2,
             color = ~PalWHO(`Building Type`),
             radius = ~ifelse(`Building Type` == "Hospital", 10, 5),
             fillOpacity = 1.0,
             stroke = TRUE,
             opacity = 1.0,
             weight = 0.5,
             popup = PopSchoolsNO2,
             group = "Schools (NO2)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'Gold'
                } else if (childCount < 100) {  
                  c = 'Gold'  
                } else { 
                  c = 'Gold'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = GPsNO2,
             color = ~PalWHO(`Building Type`),
             radius = ~ifelse(`Building Type` == "Hospital", 10, 5),
             fillOpacity = 1.0,
             stroke = TRUE,
             opacity = 1.0,
             weight = 0.5,
             popup = PopGPsNO2,
             group = "GP (NO2)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'Orange'
                } else if (childCount < 100) {  
                  c = 'Orange'  
                } else { 
                  c = 'Orange'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = HospitalsNO2,
             color = ~PalWHO(`Building Type`),
             radius = ~ifelse(`Building Type` == "Hospital", 10, 5),
             fillOpacity = 1.0,
             stroke = TRUE,
             opacity = 1.0,
             weight = 0.5,
             popup = PopHospitalsNO2,
             group = "Hospital (NO2)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'Red'
                } else if (childCount < 100) {  
                  c = 'Red'  
                } else { 
                  c = 'Red'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = SchoolsPM2.5,
             color = ~PalWHO(`Building Type`),
             radius = ~ifelse(`Building Type` == "Hospital", 10, 5),
             fillOpacity = 1.0,
             stroke = TRUE,
             opacity = 1.0,
             weight = 0.5,
             popup = PopSchoolsPM2.5,
             group = "Schools (PM2.5)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'Gold'
                } else if (childCount < 100) {  
                  c = 'Gold'  
                } else { 
                  c = 'Gold'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = GPsPM2.5,
             color = ~PalWHO(`Building Type`),
             radius = ~ifelse(`Building Type` == "Hospital", 10, 5),
             fillOpacity = 1.0,
             stroke = TRUE,
             opacity = 1.0,
             weight = 0.5,
             popup = PopGPsPM2.5,
             group = "GP (PM2.5)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'Orange'
                } else if (childCount < 100) {  
                  c = 'Orange'  
                } else { 
                  c = 'Orange'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = HospitalsPM2.5,
             color = ~PalWHO(`Building Type`),
             radius = ~ifelse(`Building Type` == "Hospital", 10, 5),
             fillOpacity = 1.0,
             stroke = TRUE,
             opacity = 1.0,
             weight = 0.5,
             popup = PopHospitalsPM2.5,
             group = "Hospital (PM2.5)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'Red'
                } else if (childCount < 100) {  
                  c = 'Red'  
                } else { 
                  c = 'Red'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className:  'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addLayersControl(
    baseGroups = c("OSM (default)"),
    overlayGroups = c("Boroughs", "Wards", "Schools (All)", "GP (All)", "Hospital (All)", "Schools (NO2)", "GP (NO2)", "Hospital (NO2)", "Schools (PM2.5)", "GP (PM2.5)", "Hospital (PM2.5)"),
    options = layersControlOptions(collapsed = TRUE)
    ) %>% 
  hideGroup(c("Schools (NO2)", "GP (NO2)", "Hospital (NO2)", "Schools (PM2.5)", "GP (PM2.5)", "Hospital (PM2.5)")) %>% 
  addLegend(pal = PalAll, values = Locations$`Building Type`, title = "All Buildings") %>% 
  addLegend(pal = PalWHO, values = LocationsNO2$`Building Type`, title = "Exceeding Limits") %>% 
  addEasyButton(easyButton(
    icon="fa-globe", title="Zoom to London",
    onClick=JS("function(btn, map){ map.setView([51.5, -0.10],10); }")))

```

