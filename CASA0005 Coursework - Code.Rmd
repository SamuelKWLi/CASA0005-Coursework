---
title: "CASA0005 Coursework - Code"
output: html_document
editor_options: 
  chunk_output_type: console
---
### Packages
```{r}
library(tidyverse)
library(raster)
library(rgdal)
library(sf)
library(tmap)
library(leafpop)
library(leaflet)
library(htmltools)
library(GISTools)
library(RColorBrewer)
library(BAMMtools)
```

### Read in Concentration Rasters
```{r}
# List the full file paths of all the raster files.
PollutionFiles <- list.files("Data/Air Pollution/LAEI 2016 Concentrations", ".tif", full.names = TRUE)

# Stack the raster files into a single stack.
PollutionConc <- stack(PollutionFiles)

# List the raster names.
PollutionNames <- c("NO2", "NOx", "PM10", "PM10d", "PM2.5")

# Rename the raster files.
names(PollutionConc) <- PollutionNames

# Set BNG coordinate system.
BNG = "+init=epsg:27700"

# Set WGS84 coordinate system.
WGS84 = "+init=epsg:4326"

# Reproject raster stack into BNG.
PollutionConc <- projectRaster(PollutionConc, crs= WGS84)

```

### Crop Raster Data
```{r}
# Read in the London boundary.
OutlineLondon <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/London_Boundary.shp")

# Transform CRS into WGS84.
OutlineLondon <- st_transform(OutlineLondon, WGS84)

# Set extent to the London area.
ExtentLondon <- extent(OutlineLondon)

# Crop the rasters to the London outline.
CropNO2 <- crop(PollutionConc[[1]], OutlineLondon)
CropNOx <- crop(PollutionConc[[2]], OutlineLondon)
CropPM10 <- crop(PollutionConc[[3]], OutlineLondon)
CropPM10d <- crop(PollutionConc[[4]], OutlineLondon)
CropPM2.5 <- crop(PollutionConc[[5]], OutlineLondon)

# Mask rasters to the London outline.
MaskNO2 <-  mask(PollutionConc[[1]], OutlineLondon, na.rm=TRUE)
MaskNOx <-  mask(PollutionConc[[2]], OutlineLondon, na.rm=TRUE)
MaskPM10 <-  mask(PollutionConc[[3]], OutlineLondon, na.rm=TRUE)
MaskPM10d <-  mask(PollutionConc[[4]], OutlineLondon, na.rm=TRUE)
MaskPM2.5 <-  mask(PollutionConc[[5]], OutlineLondon, na.rm=TRUE)

# Stack the masked rasters.
PollutionLondon <- stack(MaskNO2, MaskNOx, MaskPM10, MaskPM10d, MaskPM2.5)
```

### Read in Borough and Ward Boundaries
```{r}
# Read in boundaries as spatial polygons.
Boroughs <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/London_Borough_Excluding_MHW.shp")
Wards <- st_read("Data/Boundaries and Census/statistical-gis-boundaries-london/London_Ward_CityMerged_Clip.shp")

# Convert from an sp object to sf object.
SFBoroughs <- st_as_sf(Boroughs)
SFWards <- st_as_sf(Wards)

# Transform CRS to WGS84.
SFBoroughs <- st_transform(SFBoroughs, WGS84)
SFWards <- st_transform(SFWards, WGS84)

# Select relevent columns.
SFBoroughs <- SFBoroughs[,c(1, 2, 8)]
SFWards <- SFWards[,c(1, 2, 6, 5, 8)]

# Rename columns.
colnames(SFBoroughs) <- c("Borough Name", "Borough Code", "geometry")
colnames(SFWards) <- c("Ward Name", "Ward Code", "Borough Name", "Borough Code", "geometry")
```


### Read in Code Points
```{r}
# List full file paths for all of the code point csv files.
CodePointsFiles <- list.files(path = "Data/Schools and Health/OS Point Codes/Data", full.names=TRUE)

# Run a function for each code point file path, reading the csvs into an object.
AllCodePoints <- lapply(CodePointsFiles,function(i){
  read.csv(i, header=FALSE, skip=4)
})

# Convert the object into a data frame.
AllCodePoints <- do.call(rbind.data.frame, AllCodePoints)

# Rename the columns.
colnames(AllCodePoints) <- c("Postcode",	"Positional_quality_indicator",	"Eastings",	"Northings",	"Country_code",	"NHS_regional_HA_code",	"NHS_HA_code",	"Admin_county_code",	"Admin_district_code",	"Admin_ward_code")

# Specify relevent columns.
AllCodePoints <- AllCodePoints[,c(1, 3, 4)]

# Remove spaces in postcodes
AllCodePoints$Postcode <- gsub(" ","", AllCodePoints$Postcode)

# Write complete dataframe into a csv file.
write.csv(AllCodePoints,"AllCodePoints.csv", row.names=FALSE)

```

### Read in School, GP and Hospital Data
```{r}
# Read in  data.
Schools <- read_csv("Data/Schools and Health/All School Locations 2016.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
GPs <- read_csv("Data/Schools and Health/GP Locations.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
Hospitals <- read_csv("Data/Schools and Health/Hospital Locations.csv",
                       locale = locale(encoding = "latin1"),
                       na = "n/a")
# Select the necessary columns.
Schools <- Schools[,c(3, 8)]
GPs <- GPs[,c(1, 9)]
Hospitals <- Hospitals[,c(1, 9)]

# Rename Columns.
colnames(Schools) <- c("Name", "Postcode")
colnames(GPs) <- c("Name", "Postcode")
colnames(Hospitals) <- c("Name", "Postcode")

# Classify data.
Schools$Type <- "School"
GPs$Type <- "GP"
Hospitals$Type <- "Hospital"

# Merge school, GP and hospital points.
Locations <- rbind(Schools, GPs, Hospitals)

# Remove space in postcodes
Locations$Postcode <- gsub(" ","", Locations$Postcode)

# Attach code points.
Locations<-merge(Locations, 
             AllCodePoints, 
             by.x="Postcode", 
             by.y="Postcode",
             no.dups = TRUE)

# Reorder columns
Locations <- Locations[,c(2, 1, 3, 4, 5)]

# Remove duplicates.
Locations <- Locations[!duplicated(Locations$Name), ]

```

### Extract Concentrations for Schools, GPs and Hospitals
```{r}
# Convert location coordinates into point geometry.
SFLocations <- st_as_sf(Locations, coords = c("Eastings", "Northings"), crs = BNG)

# Transform CRS into WGS84.
SFLocations <- st_transform(SFLocations, WGS84)

# Select points inside London.
SFLocations <- SFLocations[SFBoroughs,]

# Extract concentrations.
SFLocations$`NO2 (µg/m³)`<- raster::extract(PollutionConc[[1]], SFLocations)
SFLocations$`PM2.5 (µg/m³)`<- raster::extract(PollutionConc[[5]], SFLocations)

# Round concentrations to 2 d.p..
SFLocations$`NO2 (µg/m³)` <- round(SFLocations$`NO2 (µg/m³)`, digits = 2)
SFLocations$`PM2.5 (µg/m³)` <- round(SFLocations$`PM2.5 (µg/m³)`, digits = 2)

# Rename columns.
colnames(SFLocations) <- c("Building Name", "Postcode", "Building Type", "geometry", "NO2 (µg/m³)", "PM2.5 (µg/m³)")

# Extract schools, GPs and hospitals that exceed WHO guides
SFLocationsNO2 <- SFLocations %>% filter(`NO2 (µg/m³)` > 40)
SFLocationsPM2.5 <- SFLocations %>% filter(`PM2.5 (µg/m³)` > 10)

```

### Subset Location Data and Set Up Popups
```{r}
SFSchools <- subset(SFLocations, `Building Type` == "School")

SFGPs <- subset(SFLocations, `Building Type` == "GP")

SFHospitals <- subset(SFLocations, `Building Type` == "Hospital")

SFSchoolsNO2 <- subset(SFLocationsNO2, `Building Type` == "School")

SFGPsNO2 <- subset(SFLocationsNO2, `Building Type` == "GP")

SFHospitalsNO2 <- subset(SFLocationsNO2, `Building Type` == "Hospital")

SFSchoolsPM2.5 <- subset(SFLocationsPM2.5, `Building Type` == "School")

SFGPsPM2.5 <- subset(SFLocationsPM2.5, `Building Type` == "GP")

SFHospitalsPM2.5 <- subset(SFLocationsPM2.5, `Building Type` == "Hospital")

```

### Ward Data for Points
```{r}
# Convert SF objects into SP objects
SPBoroughs <- as(SFBoroughs, "Spatial")
SPWards <- as(SFWards, "Spatial")
SPSchools <- as(SFSchools, "Spatial")
SPGPs <- as(SFGPs, "Spatial")
SPHospitals <- as(SFHospitals, "Spatial")
SPSchoolsNO2 <- as(SFSchoolsNO2, "Spatial")
SPGPsNO2 <- as(SFGPsNO2, "Spatial")
SPHospitalsNO2 <- as(SFHospitalsNO2, "Spatial")
SPSchoolsPM2.5 <- as(SFSchoolsPM2.5, "Spatial")
SPGPsPM2.5 <- as(SFGPsPM2.5, "Spatial")
SPHospitalsPM2.5 <- as(SFHospitalsPM2.5, "Spatial")

# Transform CRS to BNG (a projected CRS).
SPBoroughs <- spTransform(SPBoroughs, BNG)
SPWards <- spTransform(SPWards, BNG)
SPSchools <- spTransform(SPSchools, BNG)
SPGPs <- spTransform(SPGPs, BNG)
SPHospitals <- spTransform(SPHospitals, BNG)
SPSchoolsNO2 <- spTransform(SPSchoolsNO2, BNG)
SPGPsNO2 <- spTransform(SPGPsNO2, BNG)
SPHospitalsNO2 <- spTransform(SPHospitalsNO2, BNG)
SPSchoolsPM2.5 <- spTransform(SPSchoolsPM2.5, BNG)
SPGPsPM2.5 <- spTransform(SPGPsPM2.5, BNG)
SPHospitalsPM2.5 <- spTransform(SPHospitalsPM2.5, BNG)

# Count the number of points in each ward.
SPWards@data$SchoolCount <- poly.counts(SPSchools, SPWards)
SPWards@data$GPCount <- poly.counts(SPGPs, SPWards)
SPWards@data$HospitalCount <- poly.counts(SPHospitals, SPWards)
SPWards@data$SchoolNO2Count <- poly.counts(SPSchoolsNO2, SPWards)
SPWards@data$GPNO2Count <- poly.counts(SPGPsNO2, SPWards)
SPWards@data$HospitalNO2Count <- poly.counts(SPHospitalsNO2, SPWards)
SPWards@data$SchoolPM2.5Count <- poly.counts(SPSchoolsPM2.5, SPWards)
SPWards@data$GPPM2.5Count <- poly.counts(SPGPsPM2.5, SPWards)
SPWards@data$HospitalPM2.5Count <- poly.counts(SPHospitalsPM2.5, SPWards)

# Calculate point density.
SPWards@data$SchoolDensity <- round(SPWards@data$SchoolCount/(poly.areas(SPWards)/1000000), digits = 3)
SPWards@data$GPDensity <- round(SPWards@data$GPCount/(poly.areas(SPWards)/1000000), digits = 3)
SPWards@data$HospitalDensity <- round(SPWards@data$HospitalCount/(poly.areas(SPWards)/1000000), digits = 3)
SPWards@data$SchoolNO2Density <- round(SPWards@data$SchoolNO2Count/(poly.areas(SPWards)/1000000), digits = 3)
SPWards@data$GPNO2Density <- round(SPWards@data$GPNO2Count/(poly.areas(SPWards)/1000000), digits = 3)
SPWards@data$HospitalNO2Density <- round(SPWards@data$HospitalNO2Count/ (poly.areas(SPWards)/1000000), digits = 3)
SPWards@data$SchoolPM2.5Density <- round(SPWards@data$SchoolPM2.5Count/ (poly.areas(SPWards)/1000000), digits = 3)
SPWards@data$GPPM2.5Density <- round(SPWards@data$GPPM2.5Count/ (poly.areas(SPWards)/1000000), digits = 3)
SPWards@data$HospitalPM2.5Density <- round(SPWards@data$HospitalPM2.5Count / (poly.areas(SPWards)/1000000), digits = 3)

# Convert SP ward data into a data frame.
SFWards <- st_as_sf(SPWards)

# Transform CRS to WGS
SFWards <- st_transform(SFWards, WGS84)

# Rename columns.
colnames(SFWards) <- c("Ward Name", "Ward Code", "Borough Name", "Borough Code", "School (All) Count", "GP (All) Count", "Hospital (All) Count", "School (NO2) Count", "GP (NO2) Count", "Hospital (NO2) Count", "School (PM2.5) Count", "GP (PM2.5) Count", "Hospital (PM2.5) Count", "School (All) Density", "GP (All) Density", "Hospital (All) Density", "School (NO2) Density", "GP (NO2) Density", "Hospital (NO2) Density", "School (PM2.5) Density", "GP (PM2.5) Density", "Hospital (PM2.5) Density", "geometry")

```

### Popup Tables and Palettes For Point Data
```{r}
# Create copies of the point data.
PopBoroughs <- SFBoroughs
PopWards <- SFWards
PopSchools <- SFSchools
PopGPs <- SFGPs
PopHospitals <- SFHospitals
PopSchoolsNO2 <- SFSchoolsNO2
PopGPsNO2 <- SFGPsNO2
PopHospitalsNO2 <- SFHospitalsNO2
PopSchoolsPM2.5 <- SFSchoolsPM2.5
PopGPsPM2.5 <- SFGPsPM2.5
PopHospitalsPM2.5 <- SFHospitalsPM2.5

# Remove geometry data.
st_geometry(PopBoroughs) <- NULL
st_geometry(PopWards) <- NULL
st_geometry(PopSchools) <- NULL
st_geometry(PopGPs) <- NULL
st_geometry(PopHospitals) <- NULL
st_geometry(PopSchoolsNO2) <- NULL
st_geometry(PopGPsNO2) <- NULL
st_geometry(PopHospitalsNO2) <- NULL
st_geometry(PopSchoolsPM2.5) <- NULL
st_geometry(PopGPsPM2.5) <- NULL
st_geometry(PopHospitalsPM2.5) <- NULL

# Create popup tables.
PopBoroughs <- popupTable(PopBoroughs, feature.id = FALSE, row.numbers = FALSE, zcol=c("Borough Name", "Borough Code"))
PopWards <- popupTable(PopWards, feature.id = FALSE, row.numbers = FALSE, zcol=c("Ward Name", "Ward Code", "Borough Name", "Borough Code"))
PopSchools <- popupTable(PopSchools, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))
PopGPs <- popupTable(PopGPs, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))
PopHospitals <- popupTable(PopHospitals, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))
PopSchoolsNO2 <- popupTable(PopSchoolsNO2, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))
PopGPsNO2 <- popupTable(PopGPsNO2, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))
PopHospitalsNO2 <- popupTable(PopHospitalsNO2, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))
PopSchoolsPM2.5 <- popupTable(PopSchoolsPM2.5, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))
PopGPsPM2.5 <- popupTable(PopGPsPM2.5, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))
PopHospitalsPM2.5 <- popupTable(PopHospitalsPM2.5, feature.id = FALSE, row.numbers = FALSE, zcol=c("Building Name", "Postcode", "Building Type", "NO2 (µg/m³)", "PM2.5 (µg/m³)"))

# Create colour palettes.
PalAll <- colorFactor(c("LightSkyBlue", "RoyalBlue", "LightGreen"), levels = c("GP", "Hospital", "School"))
PalWHO <- colorFactor(c("Orange", "Red", "Gold"), levels = c("GP", "Hospital", "School"))

```

### Popup Tables and Palettes For Ward Data
```{r}
# Create copies of the ward data.
PopDataWards <- SFWards

# Remove geometry data.
st_geometry(PopDataWards) <- NULL

# Create popup tables.
PopSchoolsWards <- popupTable(PopDataWards, feature.id = FALSE, row.numbers = FALSE, zcol=c("Ward Name", "School (All) Count", "School (All) Density"))
PopGPsWards <- popupTable(PopDataWards, feature.id = FALSE, row.numbers = FALSE, zcol=c("Ward Name", "GP (All) Count", "GP (All) Density"))
PopHospitalsWards <- popupTable(PopDataWards, feature.id = FALSE, row.numbers = FALSE, zcol=c("Ward Name", "Hospital (All) Count", "Hospital (All) Density"))
PopSchoolsWardsNO2 <- popupTable(PopDataWards, feature.id = FALSE, row.numbers = FALSE, zcol=c("Ward Name", "School (NO2) Count", "School (NO2) Density"))
PopGPsWardsNO2 <- popupTable(PopDataWards, feature.id = FALSE, row.numbers = FALSE, zcol=c("Ward Name", "GP (NO2) Count", "GP (NO2) Density"))
PopHospitalsWardsNO2 <- popupTable(PopDataWards, feature.id = FALSE, row.numbers = FALSE, zcol=c("Ward Name", "Hospital (NO2) Count", "Hospital (NO2) Density"))
PopSchoolsWardsPM2.5 <- popupTable(PopDataWards, feature.id = FALSE, row.numbers = FALSE, zcol=c("Ward Name", "School (PM2.5) Count", "School (PM2.5) Density"))
PopGPsWardsPM2.5 <- popupTable(PopDataWards, feature.id = FALSE, row.numbers = FALSE, zcol=c("Ward Name", "GP (PM2.5) Count", "GP (PM2.5) Density"))
PopHospitalsWardsPM2.5 <- popupTable(PopDataWards, feature.id = FALSE, row.numbers = FALSE, zcol=c("Ward Name", "Hospital (PM2.5) Count", "Hospital (PM2.5) Density"))

# Create palettes.
PalSchoolsWards <- colorBin("GnBu", domain = PopDataWards$`School (All) Density`, bins = getJenksBreaks(PopDataWards$`School (All) Density`, k=6))
PalGPsWards <- colorBin("GnBu", domain = PopDataWards$`GP (All) Density`, bins = getJenksBreaks(PopDataWards$`GP (All) Density`, k=6))
PalHospitalsWards <- colorBin("GnBu", domain = PopDataWards$`Hospital (All) Density`, bins = getJenksBreaks(PopDataWards$`Hospital (All) Density`, k=6))
PalSchoolsWardsNO2 <- colorBin("OrRd", domain = PopDataWards$`School (NO2) Density`, bins = getJenksBreaks(PopDataWards$`School (NO2) Density`, k=6))
PalGPsWardsNO2 <- colorBin("OrRd", domain = PopDataWards$`GP (NO2) Density`, bins = getJenksBreaks(PopDataWards$`GP (NO2) Density`, k=6))
PalHospitalsWardsNO2 <- colorBin("OrRd", domain = PopDataWards$`Hospital (NO2) Density`, bins = getJenksBreaks(PopDataWards$`Hospital (NO2) Density`, k=6))
PalSchoolsWardsPM2.5 <- colorBin("OrRd", domain = PopDataWards$`School (PM2.5) Density`, bins = getJenksBreaks(PopDataWards$`School (PM2.5) Density`, k=6))
PalGPsWardsPM2.5 <- colorBin("OrRd", domain = PopDataWards$`GP (PM2.5) Density`, bins = getJenksBreaks(PopDataWards$`GP (PM2.5) Density`, k=6))
PalHospitalsWardsPM2.5 <- colorBin("OrRd", domain = PopDataWards$`Hospital (PM2.5) Density`, bins = getJenksBreaks(PopDataWards$`Hospital (PM2.5) Density`, k=6))
```

### Plot Point Map using leaflet
```{r}
# Map using leaflet.
MapLeaflet <- leaflet() %>% 
  addTiles(group = "OSM (default)") %>% 
  addPolygons(data = SFBoroughs, 
              fill = "transparent", 
              color = "black",
              stroke = "black",
              weight = 2, 
              opacity = 1.0, 
              fillOpacity = 0,
              highlightOptions = highlightOptions(color = "white", weight = 3,bringToFront = FALSE),
              label = PopBoroughs,
              group = "Boroughs"
              ) %>% 
  addPolygons(data = SFWards, 
              fill = "transparent",
              color = "black",
              stroke = "black", 
              weight = 1, 
              opacity = 1.0, 
              fillOpacity = 0,
              highlightOptions = highlightOptions(color = "white", weight = 2, bringToFront = FALSE),
              popup = PopWards,
              group = "Wards"
              ) %>% 
  
  addPolygons(data = SFWards, 
              fillColor = ~PalSchoolsWards(`School (All) Density`),
              color = "black",
              stroke = "black", 
              weight = 1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              highlightOptions = highlightOptions(color = "white", weight = 3, bringToFront = TRUE),
              popup = PopSchoolsWards,
              group = "Wards Schools (All)"
              ) %>% 
  addPolygons(data = SFWards, 
              fillColor = ~PalGPsWards(`GP (All) Density`),
              color = "black",
              stroke = "black", 
              weight = 1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              highlightOptions = highlightOptions(color = "white", weight = 3, bringToFront = TRUE),
              popup = PopGPsWards,
              group = "Wards GPs (All)"
              ) %>% 
  addPolygons(data = SFWards, 
              fillColor = ~PalHospitalsWards(`Hospital (All) Density`),
              color = "black",
              stroke = "black", 
              weight = 1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              highlightOptions = highlightOptions(color = "white", weight = 3, bringToFront = TRUE),
              popup = PopHospitalsWards,
              group = "Wards Hospitals (All)"
              ) %>% 
  
  addPolygons(data = SFWards, 
              fillColor = ~PalSchoolsWardsNO2(`School (NO2) Density`),
              color = "black",
              stroke = "black", 
              weight = 1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              highlightOptions = highlightOptions(color = "white", weight = 3, bringToFront = TRUE),
              popup = PopSchoolsWardsNO2,
              group = "Wards Schools (NO2)"
              ) %>% 
  addPolygons(data = SFWards, 
              fillColor = ~PalGPsWardsNO2(`GP (NO2) Density`),
              color = "black",
              stroke = "black", 
              weight = 1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              highlightOptions = highlightOptions(color = "white", weight = 3, bringToFront = TRUE),
              popup = PopGPsWardsNO2,
              group = "Wards GPs (NO2)"
              ) %>% 
  addPolygons(data = SFWards, 
              fillColor = ~PalHospitalsWardsNO2(`Hospital (NO2) Density`),
              color = "black",
              stroke = "black", 
              weight = 1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              highlightOptions = highlightOptions(color = "white", weight = 3, bringToFront = TRUE),
              popup = PopHospitalsWardsNO2,
              group = "Wards Hospitals (NO2)"
              ) %>% 

  addPolygons(data = SFWards, 
              fillColor = ~PalSchoolsWardsPM2.5(`School (PM2.5) Density`),
              color = "black",
              stroke = "black", 
              weight = 1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              highlightOptions = highlightOptions(color = "white", weight = 3, bringToFront = TRUE),
              popup = PopSchoolsWardsPM2.5,
              group = "Wards Schools (PM2.5)"
              ) %>% 
  addPolygons(data = SFWards, 
              fillColor = ~PalGPsWardsPM2.5(`GP (PM2.5) Density`),
              color = "black",
              stroke = "black", 
              weight = 1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              highlightOptions = highlightOptions(color = "white", weight = 3, bringToFront = TRUE),
              popup = PopGPsWardsPM2.5,
              group = "Wards GPs (PM2.5)"
              ) %>% 
  addPolygons(data = SFWards, 
              fillColor = ~PalHospitalsWardsPM2.5(`Hospital (PM2.5) Density`),
              color = "black",
              stroke = "black", 
              weight = 1, 
              opacity = 1.0, 
              fillOpacity = 1.0,
              highlightOptions = highlightOptions(color = "white", weight = 3, bringToFront = TRUE),
              popup = PopHospitalsWardsPM2.5,
              group = "Wards Hospitals (PM2.5)"
              ) %>% 
  
  addCircleMarkers(data = SFSchools,
             radius = 5,
             fillColor = ~PalAll(`Building Type`),
             fillOpacity = 1.0,
             stroke = TRUE,
             color = "black",
             opacity = 1.0,
             weight = 1.0,
             popup = PopSchools,
             group = "Schools (All)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'LightGreen'
                } else if (childCount < 100) {  
                  c = 'LightGreen'  
                } else { 
                  c = 'LightGreen'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = SFGPs,
             radius = 5,
             fillColor = ~PalAll(`Building Type`),
             fillOpacity = 1.0,
             stroke = TRUE,
             color = "black",
             opacity = 1.0,
             weight = 1.0,
             popup = PopGPs,
             group = "GP (All)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'LightSkyBlue'
                } else if (childCount < 100) {  
                  c = 'LightSkyBlue'  
                } else { 
                  c = 'LightSkyBlue'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = SFHospitals,
             radius = 5,
             fillColor = ~PalAll(`Building Type`),
             fillOpacity = 1.0,
             stroke = TRUE,
             color = "black",
             opacity = 1.0,
             weight = 1.0,
             popup = PopHospitals,
             group = "Hospital (All)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'RoyalBlue'
                } else if (childCount < 100) {  
                  c = 'RoyalBlue'  
                } else { 
                  c = 'RoyalBlue'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  
  addCircleMarkers(data = SFSchoolsNO2,
             radius = 5,
             fillColor = ~PalWHO(`Building Type`),
             fillOpacity = 1.0,
             stroke = TRUE,
             color = "black",
             opacity = 1.0,
             weight = 1.0,
             popup = PopSchoolsNO2,
             group = "Schools (NO2)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'Gold'
                } else if (childCount < 100) {  
                  c = 'Gold'  
                } else { 
                  c = 'Gold'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = SFGPsNO2,
             radius = 5,
             fillColor = ~PalWHO(`Building Type`),
             fillOpacity = 1.0,
             stroke = TRUE,
             color = "black",
             opacity = 1.0,
             weight = 1.0,
             popup = PopGPsNO2,
             group = "GP (NO2)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'Orange'
                } else if (childCount < 100) {  
                  c = 'Orange'  
                } else { 
                  c = 'Orange'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = SFHospitalsNO2,
             radius = 5,
             fillColor = ~PalWHO(`Building Type`),
             fillOpacity = 1.0,
             stroke = TRUE,
             color = "black",
             opacity = 1.0,
             weight = 1.0,
             popup = PopHospitalsNO2,
             group = "Hospital (NO2)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'Red'
                } else if (childCount < 100) {  
                  c = 'Red'  
                } else { 
                  c = 'Red'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  
  addCircleMarkers(data = SFSchoolsPM2.5,
             radius = 5,
             fillColor = ~PalWHO(`Building Type`),
             fillOpacity = 1.0,
             stroke = TRUE,
             color = "black",
             opacity = 1.0,
             weight = 1.0,
             popup = PopSchoolsPM2.5,
             group = "Schools (PM2.5)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'Gold'
                } else if (childCount < 100) {  
                  c = 'Gold'  
                } else { 
                  c = 'Gold'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = SFGPsPM2.5,
             radius = 5,
             fillColor = ~PalWHO(`Building Type`),
             fillOpacity = 1.0,
             stroke = TRUE,
             color = "black",
             opacity = 1.0,
             weight = 1.0,
             popup = PopGPsPM2.5,
             group = "GP (PM2.5)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'Orange'
                } else if (childCount < 100) {  
                  c = 'Orange'  
                } else { 
                  c = 'Orange'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className: 'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  addCircleMarkers(data = SFHospitalsPM2.5,
             radius = 5,
             fillColor = ~PalWHO(`Building Type`),
             fillOpacity = 1.0,
             stroke = TRUE,
             color = "black",
             opacity = 1.0,
             weight = 1.0,
             popup = PopHospitalsPM2.5,
             group = "Hospital (PM2.5)",
             clusterOptions = markerClusterOptions(disableClusteringAtZoom = 13, iconCreateFunction=JS("function (cluster) {    
                var childCount = cluster.getChildCount();  
                if (childCount < 10) {  
                  c = 'Red'
                } else if (childCount < 100) {  
                  c = 'Red'  
                } else { 
                  c = 'Red'  
                }    
                return new L.DivIcon({ html: '<div style=\"background-color:'+c+'\"><span>' + childCount + '</span></div>', 
                className:  'marker-cluster', 
                iconSize: new L.Point(40, 40) });
              }"))
             ) %>% 
  
  addLayersControl(
    baseGroups = c("OSM (default)"),
    overlayGroups = c("Boroughs", "Wards", "Schools (All)", "GP (All)", "Hospital (All)", "Schools (NO2)", "GP (NO2)", "Hospital (NO2)", "Schools (PM2.5)", "GP (PM2.5)", "Hospital (PM2.5)", "Wards Schools (All)", "Wards GPs (All)", "Wards Hospitals (All)", "Wards Schools (NO2)", "Wards GPs (NO2)", "Wards Hospitals (NO2)", "Wards Schools (PM2.5)", "Wards GPs (PM2.5)", "Wards Hospitals (PM2.5)"),
    position = "topright",
    options = layersControlOptions(collapsed = TRUE)
    ) %>% 
  
  addLegend(pal = PalAll, values = SFLocations$`Building Type`, title = "All Buildings") %>% 
  addLegend(pal = PalWHO, values = SFLocationsNO2$`Building Type`, title = "Exceeding Limits") %>% 
  addLegend(pal = PalSchoolsWards, values = SFWards$`School (All) Density`, title = "School Density (per km2)", group = "Wards Schools (All)") %>%
  addLegend(pal = PalGPsWards, values = SFWards$`GP (All) Density`, title = "GP Density (per km2)", group = "Wards GPs (All)") %>%
  addLegend(pal = PalHospitalsWards, values = SFWards$`Hospital (All) Density`, title = "Hospital Density (per km2)", group = "Wards Hospitals (All)") %>%
  addLegend(pal = PalSchoolsWardsNO2, values = SFWards$`School (NO2) Density`, title = "School NO2 Density (per km2)", group = "Wards Schools (NO2)") %>%
  addLegend(pal = PalGPsWardsNO2, values = SFWards$`GP (NO2) Density`, title = "GP NO2 Density (per km2)", group = "Wards GPs (NO2)") %>%
  addLegend(pal = PalHospitalsWardsNO2, values = SFWards$`Hospital (NO2) Density`, title = "Hospital NO2 Density (per km2)", group = "Wards Hospitals (NO2)") %>%
  addLegend(pal = PalSchoolsWardsPM2.5, values = SFWards$`School (PM2.5) Density`, title = "School PM2.5 Density (per km2)", group = "Wards Schools (PM2.5)") %>%
  addLegend(pal = PalGPsWardsPM2.5, values = SFWards$`GP (PM2.5) Density`, title = "GP PM2.5 Density (per km2)", group = "Wards GPs (PM2.5)") %>%
  addLegend(pal = PalHospitalsWardsPM2.5, values = SFWards$`Hospital (PM2.5) Density`, title = "Hospital PM2.5 Density (per km2)", group = "Wards Hospitals (PM2.5)") %>%
  
  hideGroup(c("Schools (NO2)", "GP (NO2)", "Hospital (NO2)", "Schools (PM2.5)", "GP (PM2.5)", "Hospital (PM2.5)", "Wards Schools (All)", "Wards GPs (All)", "Wards Hospitals (All)", "Wards Schools (NO2)", "Wards GPs (NO2)", "Wards Hospitals (NO2)", "Wards Schools (PM2.5)", "Wards GPs (PM2.5)", "Wards Hospitals (PM2.5)")) %>% 
  addEasyButton(easyButton(
    icon="fa-globe", title="Zoom to London",
    onClick=JS("function(btn, map){ map.setView([51.5, -0.10],10); }"))) %>% 
  addScaleBar(position = "bottomleft", 
              options = scaleBarOptions(metric = TRUE))
  
MapLeaflet
```

